<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#080c14">
<title>Sofra ‚Äî Compl√©ter votre profil</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Amiri:wght@400;700&display=swap');
:root{
  --bg:#080c14;--bg2:#0d1220;--surface:#111827;--surface2:#1a2438;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --green:#22c55e;--green2:#16a34a;--green-dim:rgba(34,197,94,0.1);--accent:#c9a84c;--accent2:#a07830;--accent-dim:rgba(201,168,76,0.1);
  --gold:#f59e0b;--gold-dim:rgba(245,158,11,0.1);
  --danger:#ef4444;--danger-dim:rgba(239,68,68,0.1);
  --blue:#3b82f6;--blue-dim:rgba(59,130,246,0.1);
  --text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:24px 16px 48px}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 30%,rgba(201,168,76,0.04) 0%,transparent 60%),radial-gradient(ellipse at 80% 70%,rgba(245,158,11,0.03) 0%,transparent 50%);pointer-events:none;z-index:0}
.wrap{max-width:520px;margin:0 auto;position:relative;z-index:1}

/* HEADER */
.hdr{text-align:center;margin-bottom:24px}
.hdr-logo{font-family:'Space Grotesk',sans-serif;font-size:1.1rem;font-weight:300;letter-spacing:0.2em;color:var(--text);margin-bottom:4px}
.hdr-logo span{color:var(--gold);font-weight:700}
.hdr-sub{font-size:0.75rem;color:var(--text3)}

/* LANG SWITCHER */
.lang-row{display:flex;gap:8px;justify-content:center;margin-bottom:22px}
.lang-btn{padding:5px 14px;border-radius:20px;border:1.5px solid var(--border2);background:var(--surface);color:var(--text2);font-family:'Space Grotesk',sans-serif;font-size:0.75rem;font-weight:600;cursor:pointer;transition:all 0.15s}
.lang-btn.active{background:var(--gold);color:#0d0a02;border-color:var(--gold)}

/* STEP INDICATOR */
.steps{display:flex;align-items:center;gap:0;margin-bottom:24px}
.step{flex:1;text-align:center;position:relative}
.step-num{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:2px solid var(--border2);color:var(--text3);font-size:0.78rem;font-weight:700;display:flex;align-items:center;justify-content:center;margin:0 auto 4px}
.step.active .step-num{background:var(--accent);border-color:var(--accent);color:#07080f}
.step.done .step-num{background:var(--surface);border-color:var(--accent);color:var(--accent)}
.step-label{font-size:0.62rem;color:var(--text3);font-weight:500;white-space:nowrap}
.step.active .step-label{color:var(--accent)}
.step-line{flex:1;height:1px;background:var(--border2);margin-top:-14px}
.step.done+.step-line{background:var(--accent)}

/* FORM CARD */
.fcard{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:24px;position:relative;overflow:hidden;margin-bottom:14px}
.fcard::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
.fcard-title{font-size:1rem;font-weight:700;margin-bottom:6px;color:var(--text)}
.fcard-sub{font-size:0.8rem;color:var(--text3);margin-bottom:18px;line-height:1.5}

.field{margin-bottom:14px}
.field label{display:block;font-size:0.7rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px}
.fi{width:100%;background:var(--bg2);border:1px solid var(--border2);border-radius:10px;color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:0.92rem;padding:12px 14px;outline:none;transition:border-color 0.2s,box-shadow 0.2s}
.fi:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(201,168,76,0.1)}
.fi::placeholder{color:var(--text3)}
.fi:disabled{opacity:0.6;cursor:not-allowed}
select.fi{cursor:pointer}
select.fi option{background:var(--surface)}
.fi-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* PHONE ROW */
.phone-row{display:flex;gap:8px;margin-bottom:14px}
.phone-row .fi{flex:1}
.vbtn{padding:12px 18px;background:var(--accent);color:#07080f;border:none;border-radius:10px;font-family:'Space Grotesk',sans-serif;font-size:0.88rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 0.15s;flex-shrink:0}
.vbtn:hover{background:var(--accent2)}
.vbtn:disabled{background:var(--surface2);color:var(--text3);cursor:not-allowed}

/* PROFILE FOUND */
.profile-found{background:var(--accent-dim);border:1.5px solid rgba(201,168,76,0.3);border-radius:14px;padding:18px;margin-bottom:16px;display:none}
.profile-found.show{display:block}
.pf-label{font-size:0.68rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px}
.pf-name{font-size:1.1rem;font-weight:700;margin-bottom:4px}
.pf-details{font-size:0.82rem;color:var(--text2);line-height:1.6}

/* FASTING TOGGLE */
.fast-toggle{display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1.5px solid var(--border2);border-radius:12px;padding:13px 16px;cursor:pointer;transition:all 0.2s;margin-bottom:14px}
.fast-toggle.on{border-color:rgba(201,168,76,0.4);background:var(--accent-dim)}
.fast-toggle-info{font-size:0.9rem;font-weight:600}
.fast-toggle-sub{font-size:0.72rem;color:var(--text3);margin-top:2px}
.sw{width:40px;height:22px;background:var(--surface2);border-radius:11px;position:relative;transition:background 0.2s;flex-shrink:0}
.sw.on{background:var(--accent)}
.sw::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3)}
.sw.on::after{transform:translateX(18px)}

/* VERIFY PANEL */
.verify-panel{display:none;margin-top:14px}
.verify-panel.show{display:block}

/* SUBMIT BTN */
.submit-btn{width:100%;padding:14px;background:linear-gradient(135deg,#c9a84c,#a07830);color:#07080f;border:none;border-radius:12px;font-family:'Space Grotesk',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:6px;letter-spacing:0.2px}
.submit-btn:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(201,168,76,0.25)}
.submit-btn:active{transform:scale(0.98)}
.submit-btn:disabled{background:var(--surface2);color:var(--text3);cursor:not-allowed;transform:none;box-shadow:none}

/* ERROR / SUCCESS */
.ebox{background:var(--danger-dim);border:1px solid var(--danger);border-radius:8px;padding:10px 14px;font-size:0.83rem;color:var(--danger);margin-bottom:14px;display:none}
.sbox{background:var(--accent-dim);border:1px solid var(--accent);border-radius:8px;padding:10px 14px;font-size:0.83rem;color:var(--accent);margin-bottom:14px;display:none}

/* SUCCESS */
.success-screen{display:none;text-align:center;padding:40px 20px}
.success-screen.show{display:block}
.success-icon{font-size:4rem;margin-bottom:16px;animation:pop 0.4s ease}
@keyframes pop{0%{transform:scale(0)}80%{transform:scale(1.1)}100%{transform:scale(1)}}
.success-title{font-family:'Amiri',serif;font-size:1.5rem;font-weight:700;color:var(--accent);margin-bottom:8px}
.success-sub{font-size:0.9rem;color:var(--text2);line-height:1.6;max-width:340px;margin:0 auto 14px}
.success-badge{display:inline-flex;align-items:center;gap:6px;background:var(--accent-dim);border:1px solid rgba(201,168,76,0.3);border-radius:20px;padding:6px 14px;font-size:0.78rem;font-weight:600;color:var(--accent)}

.hidden{display:none!important}
.footer{text-align:center;margin-top:28px;font-family:'Amiri',serif;font-size:0.82rem;color:rgba(201,168,76,0.3);letter-spacing:1px}
.back-link{display:block;text-align:center;margin-top:14px;font-size:0.8rem;color:var(--text3);cursor:pointer;text-decoration:none}
.back-link:hover{color:var(--accent)}

.toast{position:fixed;bottom:28px;right:28px;background:#1e2d42;color:#f1f5f9;padding:12px 20px;border-radius:12px;font-size:0.86rem;font-weight:600;border:1px solid rgba(255,255,255,0.12);box-shadow:0 8px 30px rgba(0,0,0,0.4);opacity:0;transform:translateY(10px);transition:all 0.3s;pointer-events:none;z-index:9999;max-width:320px}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="hdr">
    <div class="hdr-logo"><span>S</span>OFRA</div>
    <div class="hdr-sub" id="hdr-sub">Compl√©ter votre profil</div>
  </div>

  <!-- LANG SWITCHER -->
  <div class="lang-row">
    <button class="lang-btn active" onclick="setLang('fr')">üá´üá∑ Fran√ßais</button>
    <button class="lang-btn" onclick="setLang('ar')">üá≤üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
    <button class="lang-btn" onclick="setLang('en')">üá¨üáß English</button>
  </div>

  <!-- STEP INDICATOR -->
  <div class="steps" id="stepRow">
    <div class="step active" id="step1">
      <div class="step-num">1</div>
      <div class="step-label" id="step1-label">Trouver</div>
    </div>
    <div class="step-line" id="line12"></div>
    <div class="step" id="step2">
      <div class="step-num">2</div>
      <div class="step-label" id="step2-label">V√©rifier</div>
    </div>
    <div class="step-line" id="line23"></div>
    <div class="step" id="step3">
      <div class="step-num">3</div>
      <div class="step-label" id="step3-label">Compl√©ter</div>
    </div>
  </div>

  <!-- STEP 1: PHONE LOOKUP -->
  <div class="fcard" id="step1Card">
    <div class="fcard-title" id="s1-title">üîç Retrouver votre profil</div>
    <div class="fcard-sub" id="s1-sub">Si vous avez donn√© votre nom et num√©ro de t√©l√©phone √† la FMPC, entrez votre num√©ro ci-dessous pour retrouver votre profil.</div>
    <div class="ebox" id="s1Error"></div>
    <div class="phone-row">
      <input type="tel" class="fi" id="rPhone" placeholder="+212601234567" onkeydown="if(event.key==='Enter')lookupPhone()"/>
      <button class="vbtn" id="lookupBtn" onclick="lookupPhone()"><span id="lookup-btn-label">Rechercher</span></button>
    </div>
    <div class="profile-found" id="profileFound">
      <div class="pf-label" id="pf-label-text">C'est vous ?</div>
      <div class="pf-name" id="pfName"></div>
      <div class="pf-details" id="pfDetails"></div>
    </div>
    <button class="submit-btn hidden" id="confirmBtn" onclick="confirmProfile()">
      <span id="confirm-btn-label">‚úÖ Oui, c'est moi ‚Äî Continuer</span>
    </button>
    <div style="margin-top:8px;text-align:center">
      <a href="register.html" class="back-link" id="not-found-link" style="display:none" id="registerLink">
        <span id="not-found-text">Pas trouv√© ? S'inscrire comme nouveau ‚Üí</span>
      </a>
    </div>
  </div>

  <!-- STEP 2: EMAIL VERIFICATION -->
  <div class="fcard hidden" id="step2Card">
    <div class="fcard-title" id="s2-title">üìß V√©rification par e-mail</div>
    <div class="fcard-sub" id="s2-sub">Pour s√©curiser votre profil, entrez votre adresse e-mail. Vous recevrez un code √† 6 chiffres.</div>
    <div class="ebox" id="s2Error"></div>
    <div class="field">
      <label id="l-email">Adresse e-mail</label>
      <input type="email" class="fi" id="emailInput" placeholder="ahmed@email.com"/>
    </div>
    <button class="submit-btn" id="sendCodeBtn" onclick="sendVerifyCode()">
      <span id="send-code-label">üì® Envoyer le code</span>
    </button>

    <!-- Code entry panel -->
    <div class="fcard hidden" id="verifyPanel">
      <div style="text-align:center;padding:20px 16px">
        <div style="font-size:3rem;margin-bottom:12px">üì¨</div>
        <div style="font-size:1rem;font-weight:700;color:var(--text);margin-bottom:8px" id="code-sent-msg">V√©rifiez votre bo√Æte mail</div>
        <div style="font-size:0.82rem;color:var(--text2);line-height:1.6" id="code-sent-sub">
          Nous vous avons envoy√© un lien de v√©rification.<br/>
          Cliquez sur le lien dans l'email pour continuer.
        </div>
        <div style="margin-top:14px;padding:10px 14px;background:var(--bg2);border-radius:8px;font-size:0.75rem;color:var(--text3)">
          üí° V√©rifiez aussi vos spams
        </div>
      </div>
      <div class="ebox" id="verifyError"></div>
      <div style="margin-top:4px;text-align:center">
        <button style="background:none;border:none;color:var(--text3);font-family:'Space Grotesk',sans-serif;font-size:0.78rem;cursor:pointer" id="resendBtn" onclick="resendCode()"><span id="resend-label">üîÑ Renvoyer le lien</span></button>
      </div>
    </div>div>
  </div>

  <!-- STEP 3: COMPLETE PROFILE -->
  <div class="fcard hidden" id="step3Card">
    <div class="fcard-title" id="s3-title">üìù Compl√©ter votre profil</div>
    <div class="fcard-sub" id="s3-sub">Ces informations nous aident √† mieux vous servir. Votre nom et t√©l√©phone sont pr√©-remplis.</div>
    <div class="ebox" id="s3Error"></div>

    <div class="field">
      <label id="l-name">Nom complet</label>
      <input type="text" class="fi" id="cName" disabled/>
    </div>
    <div class="field">
      <label id="l-phone">T√©l√©phone</label>
      <input type="tel" class="fi" id="cPhone" disabled/>
    </div>
    <div class="field">
      <label id="l-uni">Universit√© / √âcole</label>
      <input type="text" class="fi" id="cUni" placeholder="Facult√© de M√©decine..."/>
    </div>
    <div class="fi-row" style="margin-bottom:14px">
      <div class="field" style="margin-bottom:0">
        <label id="l-year">Ann√©e</label>
        <select class="fi" id="cYear">
          <option value="" id="y-placeholder">S√©lectionner...</option>
          <option value="1">1√®re ann√©e</option>
          <option value="2">2√®me ann√©e</option>
          <option value="3">3√®me ann√©e</option>
          <option value="4">4√®me ann√©e</option>
          <option value="5">5√®me ann√©e</option>
          <option value="6">6√®me ann√©e</option>
          <option value="7">7√®me / Master</option>
          <option value="other">Autre</option>
        </select>
      </div>
      <div class="field" style="margin-bottom:0">
        <label id="l-country">Pays d'origine</label>
        <input type="text" class="fi" id="cCountry" placeholder="Maroc..."/>
      </div>
    </div>
    <div class="field">
      <label id="l-city">Ville actuelle</label>
      <input type="text" class="fi" id="cCity" placeholder="Casablanca"/>
    </div>

    <div class="fast-toggle" id="fastToggle" onclick="toggleFast()">
      <div>
        <div class="fast-toggle-info" id="l-fast">üåô Je suis en train de je√ªner (Ramadan)</div>
        <div class="fast-toggle-sub" id="l-fast-sub">Cochez si vous √™tes musulman et que vous je√ªnez</div>
      </div>
      <div class="sw" id="fastSw"></div>
    </div>

    <button class="submit-btn" id="submitBtn" onclick="submitProfile()">
      <span id="submit-btn-label">üíæ Sauvegarder</span>
    </button>
  </div>

  <!-- SUCCESS -->
  <div class="success-screen" id="successScreen">
    <div class="success-icon">‚úÖ</div>
    <div class="success-title" id="success-title">Profil compl√©t√© !</div>
    <div class="success-sub" id="success-sub">Vos informations ont √©t√© mises √† jour. Notre √©quipe les v√©rifiera avant validation.</div>
    <div class="success-badge">‚úÖ Profil mis √† jour</div>
  </div>

  <a href="landing.html" class="back-link" id="back-to-home">‚Üê Retour √† l'accueil</a>
  <div class="footer">ÿ±ŸÖÿ∂ÿßŸÜ ŸÉÿ±ŸäŸÖ ‚ú¶ Ramadan Kareem</div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import{getAuth,sendSignInLinkToEmail,isSignInWithEmailLink,signInWithEmailLink}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import{getFirestore,collection,addDoc,getDocs,getDoc,doc,updateDoc,serverTimestamp}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const FC={apiKey:"AIzaSyB_SeMMk-2mL_XYTKEemoIeh_j2odQ6LNk",authDomain:"ramadan-food-aid.firebaseapp.com",projectId:"ramadan-food-aid",storageBucket:"ramadan-food-aid.firebasestorage.app",messagingSenderId:"836613630009",appId:"1:836613630009:web:c5b3047298224ec82f05e8"};
const app=initializeApp(FC);const auth=getAuth(app);const db=getFirestore(app);

function normPhone(p){
  let n=String(p||'').replace(/[\s\-\.\(\)]/g,'');
  if(n.startsWith('00212'))n='+212'+n.slice(5);
  if(n.startsWith('212')&&!n.startsWith('+'))n='+212'+n.slice(3);
  if(n.startsWith('0')&&n.length===10)n='+212'+n.slice(1);
  if(/^[6-7]\d{8}$/.test(n))n='+212'+n;
  return n;
}

let authReady=false;
let foundPerson=null;
let fastOn=false;
let verifiedEmail=null;
let pendingCodeId=null;
let pendingCode=null;
let lang='fr';

// No anon auth - using email link verification

// ‚îÄ‚îÄ HANDLE EMAIL LINK RETURN ‚îÄ‚îÄ
(async()=>{
  if(isSignInWithEmailLink(auth, window.location.href)){
    const savedEmail = localStorage.getItem('sofra_complete_email');
    const savedPerson = localStorage.getItem('sofra_complete_person');
    if(!savedEmail || !savedPerson){
      document.querySelector('.wrap').innerHTML=`<div style="text-align:center;padding:60px 20px">
        <div style="font-size:3rem;margin-bottom:16px">‚ö†Ô∏è</div>
        <div style="font-size:1.1rem;margin-bottom:8px;color:#f1f5f9">Lien expir√©</div>
        <a href="complete.html" style="color:#c9a84c">‚Üê Recommencer</a>
      </div>`;
      return;
    }
    try {
      await signInWithEmailLink(auth, savedEmail, window.location.href);
      window.history.replaceState({},'',window.location.pathname);
      const person = JSON.parse(savedPerson);
      // Pre-fill step 3 and jump straight to it
      authReady=true;
      foundPerson=person;
      verifiedEmail=savedEmail;
      localStorage.removeItem('sofra_complete_email');
      localStorage.removeItem('sofra_complete_person');
      // Set step 3 active
      setStep(3);
      document.getElementById('s1').classList.add('hidden');
      document.getElementById('s2').classList.add('hidden');
      document.getElementById('s3').classList.remove('hidden');
      document.getElementById('cName').value=person.name||'';
      document.getElementById('cPhone').value=person.phone||'';
      document.getElementById('cUni').value=person.university||'';
      document.getElementById('cYear').value=person.yearOfStudy||'';
      document.getElementById('cCountry').value=person.country||'Maroc';
      document.getElementById('cCity').value=person.city||'';
      // Show verified badge on email
      const emailField=document.getElementById('s3-email-display');
      if(emailField) emailField.textContent=savedEmail;
    } catch(err) {
      document.querySelector('.wrap').innerHTML=`<div style="text-align:center;padding:60px 20px">
        <div style="font-size:3rem;margin-bottom:16px">‚ùå</div>
        <div style="font-size:1.1rem;margin-bottom:8px;color:#f1f5f9">Erreur: ${err.message}</div>
        <a href="complete.html" style="color:#c9a84c">‚Üê R√©essayer</a>
      </div>`;
    }
    return;
  }
  authReady=true; // Normal page load
})();

// ‚îÄ‚îÄ‚îÄ TRANSLATIONS ‚îÄ‚îÄ‚îÄ
const T={
  fr:{
    'hdr-sub':'Compl√©ter votre profil',
    'step1-label':'Trouver','step2-label':'V√©rifier','step3-label':'Compl√©ter',
    's1-title':'üîç Retrouver votre profil',
    's1-sub':'Si vous avez donn√© votre nom et num√©ro de t√©l√©phone √† la FMPC, entrez votre num√©ro ci-dessous.',
    'pf-label-text':"C'est vous ?",
    'lookup-btn-label':'Rechercher',
    'confirm-btn-label':'‚úÖ Oui, c\'est moi ‚Äî Continuer',
    'not-found-text':'Pas trouv√© ? S\'inscrire comme nouveau ‚Üí',
    's2-title':'üìß V√©rification par e-mail',
    's2-sub':'Pour s√©curiser votre profil, entrez votre adresse e-mail. Vous recevrez un code √† 6 chiffres.',
    'l-email':'Adresse e-mail',
    'send-code-label':'üì® Envoyer le code',
    'code-sent-msg':'üìß Code envoy√© !',
    'code-sent-sub':'Entrez le code √† 6 chiffres re√ßu par e-mail.',
    'l-vcode':'Code de v√©rification',
    'verify-btn-label':'‚úÖ V√©rifier',
    'resend-label':'üîÑ Renvoyer le code',
    's3-title':'üìù Compl√©ter votre profil',
    's3-sub':'Ces informations nous aident √† mieux vous servir. Votre nom et t√©l√©phone sont pr√©-remplis.',
    'l-name':'Nom complet','l-phone':'T√©l√©phone','l-uni':'Universit√© / √âcole',
    'l-year':'Ann√©e','l-country':"Pays d'origine",'l-city':'Ville actuelle',
    'l-fast':'üåô Je suis en train de je√ªner (Ramadan)',
    'l-fast-sub':'Cochez si vous √™tes musulman et que vous je√ªnez',
    'submit-btn-label':'üíæ Sauvegarder',
    'success-title':'Profil compl√©t√© !',
    'success-sub':'Vos informations ont √©t√© mises √† jour. Notre √©quipe les v√©rifiera avant validation.',
    'back-to-home':'‚Üê Retour √† l\'accueil',
  },
  ar:{
    'hdr-sub':'ÿ£ŸÉŸÖŸÑ ŸÖŸÑŸÅŸÉ ÿßŸÑÿ¥ÿÆÿµŸä',
    'step1-label':'ÿßŸÑÿ®ÿ≠ÿ´','step2-label':'ÿßŸÑÿ™ÿ≠ŸÇŸÇ','step3-label':'ÿßŸÑÿ•ŸÉŸÖÿßŸÑ',
    's1-title':'üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÑŸÅŸÉ',
    's1-sub':'ÿ•ÿ∞ÿß ÿ£ÿπÿ∑Ÿäÿ™ ÿßÿ≥ŸÖŸÉ Ÿàÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅŸÉ ŸÅŸä ÿßŸÑŸÖŸÇÿµŸÅÿå ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖŸÉ ŸÑŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÑŸÅŸÉ.',
    'pf-label-text':'ŸáŸÑ Ÿáÿ∞ÿß ÿ£ŸÜÿ™ÿü',
    'lookup-btn-label':'ÿ®ÿ≠ÿ´',
    'confirm-btn-label':'‚úÖ ŸÜÿπŸÖÿå Ÿáÿ∞ÿß ÿ£ŸÜÿß ‚Äî ŸÖÿ™ÿßÿ®ÿπÿ©',
    'not-found-text':'ŸÑŸÖ ŸäŸèÿπÿ´ÿ± ÿπŸÑŸäŸÉÿü ÿ≥ÿ¨ŸëŸÑ ŸÉÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ ‚Üí',
    's2-title':'üìß ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä',
    's2-sub':'ŸÑÿ™ÿ£ŸÖŸäŸÜ ŸÖŸÑŸÅŸÉÿå ÿ£ÿØÿÆŸÑ ÿπŸÜŸàÿßŸÜ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä. ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ±ŸÖÿ≤ÿßŸã ŸÖŸÉŸàŸÜÿßŸã ŸÖŸÜ 6 ÿ£ÿ±ŸÇÿßŸÖ.',
    'l-email':'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä',
    'send-code-label':'üì® ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ŸÖÿ≤',
    'code-sent-msg':'üìß ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ŸÖÿ≤!',
    'code-sent-sub':'ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑŸÖŸÉŸàŸÜ ŸÖŸÜ 6 ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸÖŸèÿ±ÿ≥ŸÑ ÿ•ŸÑŸâ ÿ®ÿ±ŸäÿØŸÉ.',
    'l-vcode':'ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ',
    'verify-btn-label':'‚úÖ ÿ™ÿ≠ŸÇŸÇ',
    'resend-label':'üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ',
    's3-title':'üìù ÿ£ŸÉŸÖŸÑ ŸÖŸÑŸÅŸÉ ÿßŸÑÿ¥ÿÆÿµŸä',
    's3-sub':'Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿ≥ÿßÿπÿØŸÜÿß ÿπŸÑŸâ ÿÆÿØŸÖÿ™ŸÉ ÿ®ÿ¥ŸÉŸÑ ÿ£ŸÅÿ∂ŸÑ. ÿßÿ≥ŸÖŸÉ ŸàŸáÿßÿ™ŸÅŸÉ ŸÖÿπÿ®ÿ¢ŸÜ ŸÖÿ≥ÿ®ŸÇÿßŸã.',
    'l-name':'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ','l-phone':'ÿßŸÑŸáÿßÿ™ŸÅ','l-uni':'ÿßŸÑÿ¨ÿßŸÖÿπÿ© / ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©',
    'l-year':'ÿßŸÑÿ≥ŸÜÿ©','l-country':'ÿ®ŸÑÿØ ÿßŸÑÿ£ÿµŸÑ','l-city':'ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©',
    'l-fast':'üåô ÿ£ŸÜÿß ÿµÿßÿ¶ŸÖ (ÿ±ŸÖÿ∂ÿßŸÜ)',
    'l-fast-sub':'ÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ŸÖÿ≥ŸÑŸÖÿßŸã Ÿàÿµÿßÿ¶ŸÖÿßŸã',
    'submit-btn-label':'üíæ ÿ≠ŸÅÿ∏',
    'success-title':'ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä!',
    'success-sub':'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ. ÿ≥Ÿäÿ™ÿ≠ŸÇŸÇ ŸÅÿ±ŸäŸÇŸÜÿß ŸÖŸÜŸáÿß ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ.',
    'back-to-home':'‚Üí ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',
  },
  en:{
    'hdr-sub':'Complete your profile',
    'step1-label':'Find','step2-label':'Verify','step3-label':'Complete',
    's1-title':'üîç Find your profile',
    's1-sub':'If you gave your name and phone number at the FMPC cafeteria, enter your number below.',
    'pf-label-text':'Is this you?',
    'lookup-btn-label':'Search',
    'confirm-btn-label':'‚úÖ Yes, that\'s me ‚Äî Continue',
    'not-found-text':'Not found? Register as a new student ‚Üí',
    's2-title':'üìß Email verification',
    's2-sub':'To secure your profile, enter your email address. You will receive a 6-digit code.',
    'l-email':'Email Address',
    'send-code-label':'üì® Send code',
    'code-sent-msg':'üìß Code sent!',
    'code-sent-sub':'Enter the 6-digit code sent to your email.',
    'l-vcode':'Verification code',
    'verify-btn-label':'‚úÖ Verify',
    'resend-label':'üîÑ Resend code',
    's3-title':'üìù Complete your profile',
    's3-sub':'This information helps us serve you better. Your name and phone are pre-filled.',
    'l-name':'Full Name','l-phone':'Phone','l-uni':'University / School',
    'l-year':'Year','l-country':'Country of Origin','l-city':'Current City',
    'l-fast':'üåô I am fasting (Ramadan)',
    'l-fast-sub':'Check if you are Muslim and fasting',
    'submit-btn-label':'üíæ Save',
    'success-title':'Profile completed!',
    'success-sub':'Your information has been updated. Our team will verify it before confirming.',
    'back-to-home':'‚Üê Back to home',
  }
};

function t(key){return(T[lang]&&T[lang][key])||T.fr[key]||key;}

window.setLang=l=>{
  lang=l;
  document.querySelectorAll('.lang-btn').forEach((b,i)=>{b.classList.toggle('active',['fr','ar','en'][i]===l);});
  document.documentElement.dir=l==='ar'?'rtl':'ltr';
  Object.keys(T.fr).forEach(key=>{
    const el=document.getElementById(key);
    if(el)el.textContent=t(key);
  });
  const yp=document.getElementById('y-placeholder');
  if(yp)yp.textContent=l==='ar'?'ÿßÿÆÿ™ÿ±...':l==='en'?'Select...':'S√©lectionner...';
};

// STEP NAVIGATION
function goStep(n){
  [1,2,3].forEach(i=>{
    document.getElementById('step'+i).className='step'+(i===n?' active':i<n?' done':'');
    const card=document.getElementById('step'+i+'Card');
    if(card)card.classList.toggle('hidden',i!==n);
  });
  document.getElementById('line12').style.background=n>1?'var(--accent)':'var(--border2)';
  document.getElementById('line23').style.background=n>2?'var(--accent)':'var(--border2)';
}

// STEP 1: LOOKUP
window.lookupPhone=async()=>{
  if(!authReady){showMsg('s1Error','Please wait...');return;}
  const phone=normPhone(document.getElementById('rPhone').value.trim());
  if(!phone||phone.replace(/[^\d]/g,'').length<7){showMsg('s1Error',lang==='ar'?'ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠':lang==='en'?'Invalid phone number':'Num√©ro invalide');return;}
  const btn=document.getElementById('lookupBtn');
  const span=btn.querySelector('span');
  btn.disabled=true;span.textContent='...';
  hideMsg('s1Error');
  document.getElementById('profileFound').classList.remove('show');
  document.getElementById('confirmBtn').classList.add('hidden');
  document.getElementById('not-found-link').style.display='none';

  const allSnap=await getDocs(collection(db,'people'));
  const match=allSnap.docs.find(d=>normPhone(d.data().phone||'')===phone);
  btn.disabled=false;span.textContent=t('lookup-btn-label');

  if(!match){
    const msg=lang==='ar'?'ÿßŸÑÿ±ŸÇŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.':lang==='en'?'Number not found.':'Num√©ro non trouv√©.';
    showMsg('s1Error',msg);
    document.getElementById('not-found-link').style.display='block';
    return;
  }
  foundPerson={id:match.id,...match.data()};
  const p=foundPerson;
  document.getElementById('pfName').textContent=p.name||'‚Äî';
  document.getElementById('pfDetails').innerHTML=
    `${p.university?'üéì '+p.university+'<br>':''}${p.yearOfStudy?'üìö Year '+p.yearOfStudy+'<br>':''}${p.city?'üìç '+p.city+'<br>':''}${p.fasting?'üåô '+(lang==='ar'?'ÿµÿßÿ¶ŸÖ':'Fasting'):''}`;
  document.getElementById('profileFound').classList.add('show');
  document.getElementById('confirmBtn').classList.remove('hidden');
};

window.confirmProfile=()=>{
  if(!foundPerson)return;
  goStep(2);
};

// STEP 2: EMAIL VERIFICATION
window.sendVerifyCode=async()=>{
  const email=document.getElementById('emailInput').value.trim().toLowerCase();
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    showMsg('s2Error',lang==='ar'?'ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠':lang==='en'?'Invalid email':'Email invalide');return;
  }
  // Check email not already used by someone else
  const allSnap=await getDocs(collection(db,'people'));
  const dup=allSnap.docs.find(d=>(d.data().email||'').toLowerCase()===email && d.id!==foundPerson.id);
  if(dup){
    const msg=lang==='ar'?'Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÖÿ≥ÿ¨ŸëŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ.':lang==='en'?'This email is already registered.':'Cet e-mail est d√©j√† utilis√©.';
    showMsg('s2Error',msg);return;
  }

  const btn=document.getElementById('sendCodeBtn');
  btn.disabled=true;document.getElementById('send-code-label').textContent='...';
  hideMsg('s2Error');

  // Save data for after redirect
  verifiedEmail=email;
  localStorage.setItem('sofra_complete_email', email);
  localStorage.setItem('sofra_complete_person', JSON.stringify(foundPerson));

  try{
    await sendSignInLinkToEmail(auth, email, {
      url: window.location.href.split('?')[0],
      handleCodeInApp: true
    });
    document.getElementById('verifyPanel').classList.add('show');
    document.getElementById('code-sent-msg').textContent=(
      lang==='ar'?`üìß ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿ•ŸÑŸâ ${email} ‚Äî ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ÿ±ŸäÿØŸÉ ŸàÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿ±ÿßÿ®ÿ∑`
      :lang==='en'?`üìß Link sent to ${email} ‚Äî check your inbox and click the link`
      :`üìß Lien envoy√© √† ${email} ‚Äî v√©rifiez votre bo√Æte mail et cliquez sur le lien`
    );
  }catch(e){
    showMsg('s2Error','‚ö†Ô∏è Error: '+e.message);
  }
  btn.disabled=false;document.getElementById('send-code-label').textContent=t('send-code-label');
};

window.resendCode=async()=>{
  if(!verifiedEmail)return;
  const btn=document.getElementById('resendBtn');
  btn.disabled=true;btn.querySelector('span').textContent='...';
  try{
    await sendSignInLinkToEmail(auth, verifiedEmail, {url:window.location.href.split('?')[0],handleCodeInApp:true});
    toast('üìß Nouveau lien envoy√© !');
    hideMsg('verifyError');
  }catch(e){showMsg('verifyError','‚ö†Ô∏è '+e.message);}
  btn.disabled=false;btn.querySelector('span').textContent=t('resend-label');
};

window.verifyCode_fn=async()=>{
  const entered=document.getElementById('verifyCode').value.trim();
  if(!entered||entered.length!==6){
    showMsg('verifyError',lang==='ar'?'ÿßŸÑÿ±ŸÖÿ≤ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠':lang==='en'?'Incorrect code':'Code incorrect');return;
  }
  hideMsg('verifyError');
  const btn=document.getElementById('verifyBtn');
  btn.disabled=true;document.getElementById('verify-btn-label').textContent='...';

  try{
    const snap=await getDoc(doc(db,'emailCodes',pendingCodeId));
    if(!snap.exists()||snap.data().used||snap.data().expiresAtMs<Date.now()||snap.data().code!==entered){
      showMsg('verifyError',lang==='ar'?'ÿßŸÑÿ±ŸÖÿ≤ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©':lang==='en'?'Incorrect or expired code':'Code incorrect ou expir√©');
      btn.disabled=false;document.getElementById('verify-btn-label').textContent=t('verify-btn-label');return;
    }
    await updateDoc(doc(db,'emailCodes',pendingCodeId),{used:true});
  }catch(e){
    showMsg('verifyError','‚ö†Ô∏è '+e.message);
    btn.disabled=false;document.getElementById('verify-btn-label').textContent=t('verify-btn-label');return;
  }

  // Pre-fill step 3
  document.getElementById('cName').value=foundPerson.name||'';
  document.getElementById('cPhone').value=foundPerson.phone||'';
  document.getElementById('cUni').value=foundPerson.university||'';
  document.getElementById('cYear').value=foundPerson.yearOfStudy||'';
  document.getElementById('cCountry').value=foundPerson.country||'';
  document.getElementById('cCity').value=foundPerson.city||'';
  fastOn=foundPerson.fasting||false;
  document.getElementById('fastSw').classList.toggle('on',fastOn);
  document.getElementById('fastToggle').classList.toggle('on',fastOn);

  btn.disabled=false;document.getElementById('verify-btn-label').textContent=t('verify-btn-label');
  goStep(3);
};

// STEP 3: SUBMIT
window.toggleFast=()=>{
  fastOn=!fastOn;
  document.getElementById('fastSw').classList.toggle('on',fastOn);
  document.getElementById('fastToggle').classList.toggle('on',fastOn);
};

window.submitProfile=async()=>{
  if(!foundPerson||!verifiedEmail)return;
  const uni=document.getElementById('cUni').value.trim();
  const year=document.getElementById('cYear').value;
  const country=document.getElementById('cCountry').value.trim();
  const city=document.getElementById('cCity').value.trim();

  const btn=document.getElementById('submitBtn');
  btn.disabled=true;document.getElementById('submit-btn-label').textContent='...';
  hideMsg('s3Error');

  try{
    // Submit as pending edit-request for admin approval
    await addDoc(collection(db,'pending'),{
      name:foundPerson.name,
      phone:foundPerson.phone||'',
      email:verifiedEmail,
      university:uni,yearOfStudy:year,country,city,
      fasting:fastOn,
      status:'pending',
      type:'edit-request',
      targetPersonId:foundPerson.id,
      originalName:foundPerson.name||'',
      emailVerified:true,
      submittedAt:serverTimestamp(),
      submittedAtMs:Date.now(),
      source:'complete-form'
    });
    document.getElementById('step3Card').classList.add('hidden');
    document.getElementById('stepRow').classList.add('hidden');
    document.getElementById('back-to-home').classList.add('hidden');
    document.getElementById('successScreen').classList.add('show');
  }catch(e){
    showMsg('s3Error','‚ö†Ô∏è '+e.message);
    btn.disabled=false;document.getElementById('submit-btn-label').textContent=t('submit-btn-label');
  }
};

function showMsg(id,msg){const el=document.getElementById(id);el.textContent=msg;el.style.display='block';}
function hideMsg(id){document.getElementById(id).style.display='none';}
function toast(msg,dur=3000){
  const el=document.getElementById('toast');
  el.textContent=msg;el.style.opacity='1';el.style.transform='translateY(0)';
  clearTimeout(el._t);el._t=setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(10px)'},dur);
}
</script>
</body>
</html>
