<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#080c14">
<title>Inscription â€” Ramadan Food Aid</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Amiri:wght@400;700&display=swap');
:root{--bg:#080c14;--bg2:#0d1220;--surface:#111827;--surface2:#1a2438;--border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);--green:#22c55e;--green2:#16a34a;--green-dim:rgba(34,197,94,0.1);--gold:#f59e0b;--gold-dim:rgba(245,158,11,0.1);--danger:#ef4444;--danger-dim:rgba(239,68,68,0.1);--text:#f1f5f9;--text2:#94a3b8;--text3:#64748b}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:24px 16px 48px}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 30%,rgba(34,197,94,0.05) 0%,transparent 60%),radial-gradient(ellipse at 80% 70%,rgba(245,158,11,0.04) 0%,transparent 50%);pointer-events:none;z-index:0}
.wrap{max-width:520px;margin:0 auto;position:relative;z-index:1}

/* HEADER */
.hdr{text-align:center;margin-bottom:28px}
.moon{font-size:2.5rem;display:block;filter:drop-shadow(0 0 16px rgba(245,158,11,0.5));animation:float 3s ease-in-out infinite;margin-bottom:8px}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
.hdr-title{font-family:'Amiri',serif;font-size:1.6rem;font-weight:700;color:#f1f5f9;margin-bottom:4px}
.hdr-title span{color:var(--green)}
.hdr-ar{font-family:'Amiri',serif;font-size:0.95rem;color:var(--text3);direction:rtl;margin-bottom:16px}

/* LANG SWITCHER */
.lang-row{display:flex;gap:8px;justify-content:center;margin-bottom:24px;direction:ltr}
.lang-btn{padding:6px 16px;border-radius:20px;border:1.5px solid var(--border2);background:var(--surface);color:var(--text2);font-family:'Space Grotesk',sans-serif;font-size:0.78rem;font-weight:600;cursor:pointer;transition:all 0.15s}
.lang-btn.active{background:var(--green);color:#fff;border-color:var(--green)}

/* WELCOME CARD */
.welcome{background:var(--green-dim);border:1px solid rgba(34,197,94,0.2);border-radius:14px;padding:16px 18px;margin-bottom:22px;font-size:0.88rem;color:var(--text2);line-height:1.7}
.welcome strong{color:var(--green);display:block;margin-bottom:6px;font-size:0.95rem}

/* PATH SELECTOR */
.path-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px}
.path-card{background:var(--surface);border:2px solid var(--border2);border-radius:14px;padding:18px 14px;text-align:center;cursor:pointer;transition:all 0.2s}
.path-card:hover{border-color:var(--green);background:var(--green-dim)}
.path-card.selected{border-color:var(--green);background:var(--green-dim)}
.path-icon{font-size:2rem;display:block;margin-bottom:8px}
.path-title{font-size:0.9rem;font-weight:700;margin-bottom:4px}
.path-sub{font-size:0.72rem;color:var(--text3);line-height:1.4}

/* FORM CARD */
.fcard{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:24px;position:relative;overflow:hidden}
.fcard::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--green),transparent)}
.fcard-title{font-size:1rem;font-weight:700;margin-bottom:18px;color:var(--text)}

.field{margin-bottom:14px}
.field label{display:block;font-size:0.7rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px}
.fi{width:100%;background:var(--bg2);border:1px solid var(--border2);border-radius:10px;color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:0.92rem;padding:12px 14px;outline:none;transition:border-color 0.2s,box-shadow 0.2s}
.fi:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
.fi::placeholder{color:var(--text3)}
select.fi{cursor:pointer}
select.fi option{background:var(--surface)}

/* FASTING TOGGLE */
.fast-toggle{display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1.5px solid var(--border2);border-radius:12px;padding:13px 16px;cursor:pointer;transition:all 0.2s;margin-bottom:14px}
.fast-toggle.on{border-color:rgba(34,197,94,0.4);background:var(--green-dim)}
.fast-toggle-info{font-size:0.9rem;font-weight:600}
.fast-toggle-sub{font-size:0.72rem;color:var(--text3);margin-top:2px}
.sw{width:40px;height:22px;background:var(--surface2);border-radius:11px;position:relative;transition:background 0.2s;flex-shrink:0}
.sw.on{background:var(--green)}
.sw::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3)}
.sw.on::after{transform:translateX(18px)}

/* VERIFY CARD */
.verify-card{display:none}
.verify-card.show{display:block}
.vphone-row{display:flex;gap:8px;margin-bottom:16px}
.vphone-row .fi{flex:1}
.vbtn{padding:12px 18px;background:var(--green);color:#fff;border:none;border-radius:10px;font-family:'Space Grotesk',sans-serif;font-size:0.88rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 0.15s;flex-shrink:0}
.vbtn:hover{background:var(--green2)}
.vbtn:disabled{background:var(--surface2);color:var(--text3);cursor:not-allowed}

/* FOUND PROFILE */
.profile-found{background:var(--green-dim);border:1.5px solid rgba(34,197,94,0.3);border-radius:14px;padding:18px;margin-bottom:16px;display:none}
.profile-found.show{display:block}
.pf-label{font-size:0.68rem;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px}
.pf-name{font-size:1.1rem;font-weight:700;margin-bottom:4px}
.pf-details{font-size:0.82rem;color:var(--text2);line-height:1.6}
.pf-actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}

/* SUBMIT BTN */
.submit-btn{width:100%;padding:14px;background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;border:none;border-radius:12px;font-family:'Space Grotesk',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:6px;letter-spacing:0.2px}
.submit-btn:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(34,197,94,0.3)}
.submit-btn:active{transform:scale(0.98)}
.submit-btn:disabled{background:var(--surface2);color:var(--text3);cursor:not-allowed;transform:none;box-shadow:none}

/* ERROR / SUCCESS */
.ebox{background:var(--danger-dim);border:1px solid var(--danger);border-radius:8px;padding:10px 14px;font-size:0.83rem;color:var(--danger);margin-bottom:14px;display:none}
.sbox{background:var(--green-dim);border:1px solid var(--green);border-radius:8px;padding:10px 14px;font-size:0.83rem;color:var(--green);margin-bottom:14px;display:none}

/* SUCCESS SCREEN */
.success-screen{display:none;text-align:center;padding:40px 20px}
.success-screen.show{display:block}
.success-icon{font-size:4rem;margin-bottom:16px;animation:pop 0.4s ease}
@keyframes pop{0%{transform:scale(0)}80%{transform:scale(1.1)}100%{transform:scale(1)}}
.success-title{font-family:'Amiri',serif;font-size:1.5rem;font-weight:700;color:var(--green);margin-bottom:8px}
.success-sub{font-size:0.9rem;color:var(--text2);line-height:1.6;max-width:340px;margin:0 auto}
.pending-badge{display:inline-flex;align-items:center;gap:6px;background:var(--gold-dim);border:1px solid rgba(245,158,11,0.3);border-radius:20px;padding:6px 14px;font-size:0.78rem;font-weight:600;color:var(--gold);margin-top:14px}

/* FOOTER */
.footer{text-align:center;margin-top:28px;font-family:'Amiri',serif;font-size:0.82rem;color:rgba(201,168,76,0.3);letter-spacing:1px}

.hidden{display:none!important}
.btn-outline{padding:8px 16px;border-radius:8px;border:1.5px solid var(--border2);background:transparent;color:var(--text2);font-family:'Space Grotesk',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.15s}
.btn-outline:hover{border-color:var(--green);color:var(--green)}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="hdr">
    <span class="moon">ğŸŒ™</span>
    <div class="hdr-title">Ramadan <span>Food Aid</span></div>
    <div class="hdr-ar">Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø±Ù…Ø¶Ø§Ù† Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©</div>
  </div>

  <!-- LANG SWITCHER -->
  <div class="lang-row">
    <button class="lang-btn active" onclick="setLang('fr')">ğŸ‡«ğŸ‡· FranÃ§ais</button>
    <button class="lang-btn" onclick="setLang('ar')">ğŸ‡²ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button class="lang-btn" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ English</button>
  </div>

  <!-- WELCOME MESSAGE -->
  <div class="welcome">
    <strong id="w-title">ğŸŒ™ Un mot avant de commencer</strong>
    <span id="w-body">Nous savons que votre temps est prÃ©cieux et nous vous remercions de votre patience. Nous travaillons sur un systÃ¨me permanent pour que vous n'ayez plus jamais Ã  faire cela. Pour l'instant, cette inscription unique nous aide Ã  garantir que chacun reÃ§oit ce qu'il mÃ©rite â€” rapidement et Ã©quitablement. Merci de faire partie de cette communautÃ©. ğŸŒ™</span>
  </div>

  <!-- PATH SELECTOR hidden - auto new student -->
  <div class="path-row" id="pathSelector" style="display:none">
    <div class="path-card selected" id="pathNew">
      <span class="path-icon">âœ¨</span>
      <div class="path-title" id="p-new-title">Nouveau</div>
      <div class="path-sub" id="p-new-sub">Je n'ai jamais rempli ce formulaire</div>
    </div>
    <div class="path-card" id="pathReturn" style="display:none"></div>
  </div>

  <!-- NEW STUDENT FORM -->
  <div class="fcard hidden" id="newForm">
    <div class="fcard-title" id="f-title">ğŸ“ Inscription</div>
    <div class="ebox" id="newError"></div>
    <div class="sbox" id="newSuccess"></div>

    <div class="field">
      <label id="l-name">Nom complet</label>
      <input type="text" class="fi" id="nName" placeholder="Ahmed Benali"/>
    </div>
    <div class="field">
      <label id="l-email">Adresse e-mail</label>
      <input type="email" class="fi" id="nEmail" placeholder="ahmed@email.com"/>
    </div>
    <div class="field">
      <label id="l-phone">NumÃ©ro de tÃ©lÃ©phone</label>
      <input type="tel" class="fi" id="nPhone" placeholder="+212601234567"/>
    </div>

    <div class="field">
      <label id="l-uni">UniversitÃ© / Ã‰cole</label>
      <input type="text" class="fi" id="nUni" placeholder="FacultÃ© de MÃ©decine..."/>
    </div>
    <div class="field">
      <label id="l-year">AnnÃ©e d'Ã©tudes</label>
      <select class="fi" id="nYear">
        <option value="" id="y-placeholder">SÃ©lectionner...</option>
        <option value="1">1Ã¨re annÃ©e</option>
        <option value="2">2Ã¨me annÃ©e</option>
        <option value="3">3Ã¨me annÃ©e</option>
        <option value="4">4Ã¨me annÃ©e</option>
        <option value="5">5Ã¨me annÃ©e</option>
        <option value="6">6Ã¨me annÃ©e</option>
        <option value="7">7Ã¨me annÃ©e / Master</option>
        <option value="other">Autre</option>
      </select>
    </div>
    <div class="field">
      <label id="l-country">Pays d'origine / Country of origin / Ø¨Ù„Ø¯ Ø§Ù„Ø£ØµÙ„</label>
      <input type="text" class="fi" id="nCountry" placeholder="Maroc / Morocco / Ø§Ù„Ù…ØºØ±Ø¨"/>
    </div>
    <div class="field">
      <label id="l-city">Ville actuelle / Current city / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
      <input type="text" class="fi" id="nCity" placeholder="Casablanca"/>
    </div>

    <div class="fast-toggle" id="nFastToggle" onclick="toggleFast()">
      <div>
        <div class="fast-toggle-info" id="l-fast">ğŸŒ™ Je suis en train de jeÃ»ner (Ramadan)</div>
        <div class="fast-toggle-sub" id="l-fast-sub">Cochez si vous Ãªtes musulman et que vous jeÃ»nez</div>
      </div>
      <div class="sw" id="fastSw"></div>
    </div>

    <button class="submit-btn" id="submitNewBtn" onclick="submitNew()">
      <span id="submit-label">âœ… Soumettre mon inscription</span>
    </button>


    <div style="margin-top:12px;text-align:center">
      <button class="btn-outline" onclick="resetPath()" id="back-btn">â† Retour</button>
    </div>
  </div>

  <!-- RETURNING STUDENT -->
  <div class="fcard hidden" id="returnForm">
    <div class="fcard-title" id="r-title">ğŸ”„ VÃ©rification</div>
    <div class="ebox" id="retError"></div>

    <p style="font-size:0.85rem;color:var(--text2);margin-bottom:14px" id="r-sub">Entrez votre numÃ©ro de tÃ©lÃ©phone pour retrouver votre profil.</p>

    <div class="vphone-row">
      <input type="tel" class="fi" id="rPhone" placeholder="+212601234567" onkeydown="if(event.key==='Enter')lookupPhone()"/>
      <button class="vbtn" id="lookupBtn" onclick="lookupPhone()"><span id="r-search-btn">Rechercher</span></button>
    </div>

    <!-- PROFILE FOUND -->
    <div class="profile-found" id="profileFound">
      <div class="pf-label" id="pf-label">C'est vous ?</div>
      <div class="pf-name" id="pfName">â€”</div>
      <div class="pf-details" id="pfDetails">â€”</div>
      <div class="pf-actions">
        <button class="submit-btn" style="width:auto;padding:10px 20px" onclick="confirmProfile()" id="pf-yes">âœ… Oui, c'est moi</button>
        <button class="btn-outline" onclick="editProfile()" id="pf-fix">âœï¸ Corriger</button>
      </div>
    </div>

    <!-- EDIT FIELDS (shown if they want to fix) -->
    <div class="hidden" id="editFields">
      <div style="margin-bottom:14px;font-size:0.83rem;color:var(--text2)" id="e-sub">Corrigez les informations incorrectes :</div>
      <div class="field"><label id="el-name">Nom complet</label><input type="text" class="fi" id="eName" placeholder="Nom complet"/></div>
      <div class="field"><label id="el-uni">UniversitÃ©</label><input type="text" class="fi" id="eUni" placeholder="UniversitÃ©..."/></div>
      <div class="field"><label id="el-year">AnnÃ©e d'Ã©tudes</label>
        <select class="fi" id="eYear">
          <option value="1">1Ã¨re annÃ©e</option><option value="2">2Ã¨me annÃ©e</option><option value="3">3Ã¨me annÃ©e</option>
          <option value="4">4Ã¨me annÃ©e</option><option value="5">5Ã¨me annÃ©e</option><option value="6">6Ã¨me annÃ©e</option>
          <option value="7">7Ã¨me annÃ©e / Master</option><option value="other">Autre</option>
        </select>
      </div>
      <div class="field"><label id="el-country">Pays d'origine / Country</label><input type="text" class="fi" id="eCountry" placeholder="Maroc / Morocco..."/></div>
      <div class="field"><label id="el-city">Ville actuelle / City</label><input type="text" class="fi" id="eCity" placeholder="Casablanca..."/></div>
      <div class="fast-toggle" id="eFastToggle" onclick="toggleEditFast()">
        <div><div class="fast-toggle-info" id="el-fast">ğŸŒ™ Je jeÃ»ne (Ramadan)</div></div>
        <div class="sw" id="eFastSw"></div>
      </div>
      <button class="submit-btn" onclick="submitEdit()" id="e-save">ğŸ’¾ Sauvegarder les modifications</button>
    </div>

    <div style="margin-top:12px;text-align:center">
      <button class="btn-outline" onclick="resetPath()" id="back-btn2">â† Retour</button>
    </div>
  </div>

  <!-- SUCCESS SCREEN -->
  <div class="success-screen" id="successScreen">
    <div class="success-icon">ğŸ‰</div>
    <div class="success-title" id="s-title">Demande envoyÃ©e !</div>
    <div class="success-sub" id="s-body">Votre demande a Ã©tÃ© reÃ§ue et sera vÃ©rifiÃ©e par notre Ã©quipe. Vous serez ajoutÃ© Ã  la liste dÃ¨s validation. Merci pour votre patience ! ğŸŒ™</div>
    <div class="pending-badge" id="s-badge">â³ En attente de validation</div>
  </div>

  <div class="footer">Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ… âœ¦ Ramadan Kareem âœ¦ Ramadan Moubarak</div>
</div>
<div class="toast" id="regToast" style="position:fixed;bottom:28px;right:28px;background:#1e2d42;color:#f1f5f9;padding:12px 20px;border-radius:12px;font-size:0.86rem;font-weight:600;border:1px solid rgba(255,255,255,0.12);box-shadow:0 8px 30px rgba(0,0,0,0.4);opacity:0;transform:translateY(10px);transition:all 0.3s;pointer-events:none;z-index:9999;max-width:320px"></div>


<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyB_SeMMk-2mL_XYTKEemoIeh_j2odQ6LNk",
  authDomain:"ramadan-food-aid.firebaseapp.com",
  projectId:"ramadan-food-aid",
  storageBucket:"ramadan-food-aid.firebasestorage.app",
  messagingSenderId:"836613630009",
  appId:"1:836613630009:web:c5b3047298224ec82f05e8"
});
const db = firebase.firestore();
const ST = firebase.firestore.FieldValue.serverTimestamp;

// â”€â”€ HELPERS â”€â”€
function normPhone(p){
  let n=String(p||'').replace(/[\s\-\.\(\)]/g,'');
  if(n.startsWith('00212'))n='+212'+n.slice(5);
  if(n.startsWith('212')&&!n.startsWith('+'))n='+212'+n.slice(3);
  if(n.startsWith('0')&&n.length===10)n='+212'+n.slice(1);
  if(/^[6-7]\d{8}$/.test(n))n='+212'+n;
  return n;
}
function showMsg(id,msg){const el=document.getElementById(id);if(el){el.textContent=msg;el.style.display='block';}}
function hideMsg(id){const el=document.getElementById(id);if(el){el.textContent='';el.style.display='none';}}
function toast(msg,dur=3500){const el=document.getElementById('regToast');el.textContent=msg;el.style.opacity='1';el.style.transform='translateY(0)';clearTimeout(el._t);el._t=setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(10px)';},dur);}

// â”€â”€ STATE â”€â”€
let lang='fr';
let fastOn=false;
let inviteId=null;
let invitePhone=null;

// â”€â”€ TRANSLATIONS â”€â”€
const T={
  fr:{
    'w-title':'ğŸŒ™ Un mot avant de commencer',
    'w-body':"Nous savons que votre temps est prÃ©cieux et nous vous remercions de votre patience. Cette inscription unique nous aide Ã  garantir que chacun reÃ§oit ce qu'il mÃ©rite â€” rapidement et Ã©quitablement. Merci de faire partie de cette communautÃ©. ğŸŒ™",
    'p-new-title':'Nouveau','p-new-sub':"Je n'ai jamais rempli ce formulaire",
    'p-ret-title':'DÃ©jÃ  inscrit','p-ret-sub':"J'ai dÃ©jÃ  donnÃ© mes informations",
    'f-title':'ğŸ“ Inscription',
    'l-name':'Nom complet','l-email':'Adresse e-mail','l-phone':'NumÃ©ro de tÃ©lÃ©phone',
    'l-uni':'UniversitÃ© / Ã‰cole','l-year':"AnnÃ©e d'Ã©tudes",
    'l-country':'Pays','l-city':'Ville actuelle',
    'l-fast':'ğŸŒ™ Je jeÃ»ne (Ramadan)','l-fast-sub':'Cochez si vous Ãªtes musulman et que vous jeÃ»nez',
    'submit-label':'âœ… Soumettre mon inscription',
    'err-required':'Veuillez remplir tous les champs obligatoires.',
    'err-phone':'NumÃ©ro de tÃ©lÃ©phone invalide.',
    'err-email':'Adresse e-mail invalide.',
    'err-duplicate-phone':'Ce numÃ©ro est dÃ©jÃ  inscrit.',
    'err-duplicate-email':'Cet e-mail est dÃ©jÃ  inscrit.',
    'err-pending':'Votre demande est dÃ©jÃ  en attente de validation.',
    'success-title':'Inscription soumise !',
    'success-body':"Votre inscription a Ã©tÃ© soumise avec succÃ¨s. Notre Ã©quipe va examiner votre dossier sous peu. Ramadan Mubarak ğŸŒ™",
    'back-home':'â† Retour Ã  l\'accueil',
    'err-connection':'âš ï¸ Erreur de connexion: ',
    'err-permission':'âš ï¸ Permissions insuffisantes. VÃ©rifiez les rÃ¨gles Firestore.',
    'err-generic':'âš ï¸ Erreur: '
  },
  ar:{
    'w-title':'ğŸŒ™ ÙƒÙ„Ù…Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡',
    'w-body':'Ù†Ø¹Ù„Ù… Ø£Ù† ÙˆÙ‚ØªÙƒ Ø«Ù…ÙŠÙ† ÙˆÙ†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ ØµØ¨Ø±Ùƒ. Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ±ÙŠØ¯ ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ Ø¶Ù…Ø§Ù† Ø­ØµÙˆÙ„ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠØ³ØªØ­Ù‚Ù‡. Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙˆÙ†Ùƒ Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹. ğŸŒ™',
    'p-new-title':'Ø¬Ø¯ÙŠØ¯','p-new-sub':'Ù„Ù… Ø£Ø³Ø¬Ù„ Ù…Ù† Ù‚Ø¨Ù„',
    'p-ret-title':'Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹','p-ret-sub':'Ù‚Ø¯Ù…Øª Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ Ù…Ù† Ù‚Ø¨Ù„',
    'f-title':'ğŸ“ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
    'l-name':'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„','l-email':'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ','l-phone':'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
    'l-uni':'Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© / Ø§Ù„Ù…Ø¹Ù‡Ø¯','l-year':'Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©',
    'l-country':'Ø§Ù„Ø¨Ù„Ø¯','l-city':'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
    'l-fast':'ğŸŒ™ Ø£Ù†Ø§ ØµØ§Ø¦Ù… (Ø±Ù…Ø¶Ø§Ù†)','l-fast-sub':'Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø³Ù„Ù…Ø§Ù‹ ÙˆØµØ§Ø¦Ù…Ø§Ù‹',
    'submit-label':'âœ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
    'err-required':'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.',
    'err-phone':'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­.',
    'err-email':'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.',
    'err-duplicate-phone':'Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.',
    'err-duplicate-email':'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.',
    'err-pending':'Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø§Ù„ÙØ¹Ù„.',
    'success-title':'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!',
    'success-body':'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù„ÙÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹. Ø±Ù…Ø¶Ø§Ù† Ù…Ø¨Ø§Ø±Ùƒ ğŸŒ™',
    'back-home':'â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
    'err-connection':'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ',
    'err-permission':'âš ï¸ ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore.',
    'err-generic':'âš ï¸ Ø®Ø·Ø£: '
  },
  en:{
    'w-title':'ğŸŒ™ A word before we begin',
    'w-body':"We know your time is precious and we thank you for your patience. This one-time registration helps us ensure everyone receives what they deserve â€” quickly and fairly. Thank you for being part of this community. ğŸŒ™",
    'p-new-title':'New Student','p-new-sub':"I've never filled this form before",
    'p-ret-title':'Already Registered','p-ret-sub':"I've already given my information",
    'f-title':'ğŸ“ Registration',
    'l-name':'Full name','l-email':'Email address','l-phone':'Phone number',
    'l-uni':'University / School','l-year':'Year of study',
    'l-country':'Country','l-city':'Current city',
    'l-fast':'ğŸŒ™ I am fasting (Ramadan)','l-fast-sub':'Check if you are Muslim and fasting',
    'submit-label':'âœ… Submit my registration',
    'err-required':'Please fill in all required fields.',
    'err-phone':'Invalid phone number.',
    'err-email':'Invalid email address.',
    'err-duplicate-phone':'This number is already registered.',
    'err-duplicate-email':'This email is already registered.',
    'err-pending':'Your request is already pending review.',
    'success-title':'Registration submitted!',
    'success-body':'Your registration has been submitted successfully. Our team will review your file shortly. Ramadan Mubarak ğŸŒ™',
    'back-home':'â† Back to home',
    'err-connection':'âš ï¸ Connection error: ',
    'err-permission':'âš ï¸ Insufficient permissions. Check Firestore rules.',
    'err-generic':'âš ï¸ Error: '
  }
};

function t(k){return (T[lang]||T['fr'])[k]||k;}

window.setLang=function(l){
  lang=l;
  document.documentElement.lang=l;
  document.documentElement.dir=l==='ar'?'rtl':'ltr';
  document.querySelectorAll('.lang-btn').forEach(b=>{
    b.classList.toggle('active',
      (l==='fr'&&b.textContent.includes('FranÃ§ais'))||
      (l==='ar'&&b.textContent.includes('Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'))||
      (l==='en'&&b.textContent.includes('English'))
    );
  });
  // Update all translated elements
  const ids=['w-title','w-body','p-new-title','p-new-sub','p-ret-title','p-ret-sub',
             'f-title','l-name','l-email','l-phone','l-uni','l-year','l-country','l-city',
             'l-fast','l-fast-sub','submit-label'];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.textContent=t(id);
  });
  // Re-render closed screen if visible (so it translates too)
  const cs=document.querySelector('.closed-screen');
  if(cs&&window._closedKey){
    cs.remove();
    showClosedScreen(window._closedKey);
  }
};

window.selectPath=function(path){
  document.getElementById('pathNew').classList.toggle('selected',path==='new');
  document.getElementById('pathReturn').classList.toggle('selected',path==='return');
  document.getElementById('newForm').classList.toggle('hidden',path!=='new');
  document.getElementById('returnForm').classList.toggle('hidden',path!=='return');
  hideMsg('newError');hideMsg('newSuccess');hideMsg('retError');
};

window.toggleFast=function(){
  fastOn=!fastOn;
  document.getElementById('fastSw').classList.toggle('on',fastOn);
  document.getElementById('nFastToggle').classList.toggle('on',fastOn);
};

// â”€â”€ REGISTRATION ACCESS CHECK â”€â”€
async function checkRegistrationAccess(){
  const params=new URLSearchParams(window.location.search);
  const invId=params.get('invite');

  // 1. Check if registration is globally open
  let regOpen=false;
  try{
    const snap=await db.doc('settings/registration').get();
    regOpen=snap.exists?snap.data().open===true:false;
  }catch(e){regOpen=false;}

  // 2. If invite link provided â€” validate it
  if(invId){
    try{
      const invSnap=await db.doc('invites/'+invId).get();
      if(!invSnap.exists){showClosedScreen('invalid');return;}
      const inv=invSnap.data();
      if(inv.status==='used'){showClosedScreen('used');return;}
      if(inv.status==='revoked'){showClosedScreen('revoked');return;}
      if(inv.expiresAtMs&&inv.expiresAtMs<Date.now()){showClosedScreen('expired');return;}
      inviteId=invId;
      if(inv.phone)invitePhone=inv.phone;
      // Pre-fill phone if invite has one
      if(invitePhone){
        const phoneEl=document.getElementById('nPhone');
        if(phoneEl){phoneEl.value=invitePhone;phoneEl.readOnly=true;phoneEl.style.opacity='0.7';}
      }
    }catch(e){showClosedScreen('error');}
    return;
  }

  // 3. No invite â€” check if open registration
  if(!regOpen){
    showClosedScreen('closed');
  }
}

function showClosedScreen(key){
  // Hide all form sections so nothing is accessible
  ['pathSelector','newForm','returnForm'].forEach(id=>{
    const el=document.getElementById(id);if(el){el.style.display='none';}
  });
  document.querySelectorAll('.submit-btn,.vbtn,.path-card').forEach(b=>{b.style.opacity='0.4';b.style.pointerEvents='none';});

  // Translated messages
  const msgs={
    'closed':{
      fr:['ğŸ”’','Inscription fermÃ©e',"L'inscription est actuellement fermÃ©e. Si vous avez reÃ§u un lien personnel, utilisez-le."],
      ar:['ğŸ”’','Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ØºÙ„Ù‚','Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø¥Ø°Ø§ ØªÙ„Ù‚ÙŠØª Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø´Ø®ØµÙŠØ§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡.'],
      en:['ğŸ”’','Registration Closed','Registration is currently closed. If you received a personal invitation link, please use it.']
    },
    'invalid':{
      fr:['âŒ','Lien invalide',"Ce lien d'invitation n'est pas valide."],
      ar:['âŒ','Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­','Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ù‡Ø°Ø§ ØºÙŠØ± ØµØ§Ù„Ø­.'],
      en:['âŒ','Invalid Link','This invitation link is not valid.']
    },
    'used':{
      fr:['âœ…','DÃ©jÃ  inscrit','Ce lien a dÃ©jÃ  Ã©tÃ© utilisÃ© pour complÃ©ter une inscription.'],
      ar:['âœ…','Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹','ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¥ØªÙ…Ø§Ù… ØªØ³Ø¬ÙŠÙ„.'],
      en:['âœ…','Already Registered','This invitation link has already been used to complete a registration.']
    },
    'revoked':{
      fr:['âŒ','Lien rÃ©voquÃ©','Ce lien a Ã©tÃ© rÃ©voquÃ©. Contactez l\'administration.'],
      ar:['âŒ','ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·','ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·. Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.'],
      en:['âŒ','Link Revoked','This invitation link has been revoked. Please contact the admin.']
    },
    'expired':{
      fr:['â°','Lien expirÃ©','Ce lien a expirÃ©. Demandez-en un nouveau.'],
      ar:['â°','Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·','Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·. Ø§Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.'],
      en:['â°','Link Expired','This invitation link has expired. Please ask for a new one.']
    },
    'error':{
      fr:['âš ï¸','Erreur','Impossible de valider votre lien. RÃ©essayez.'],
      ar:['âš ï¸','Ø®Ø·Ø£','ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.'],
      en:['âš ï¸','Error','Could not validate your link. Please try again.']
    }
  };
  const l=lang||'fr';
  const m=(msgs[key]||msgs['error'])[l]||msgs[key]['fr'];
  window._closedKey=key;
  const closed=document.createElement('div');
  closed.className='closed-screen';
  closed.style.cssText='text-align:center;padding:32px 20px;background:var(--surface);border:1px solid var(--border2);border-radius:16px;margin-bottom:16px';
  closed.innerHTML=`<div style="font-size:2.5rem;margin-bottom:10px">${m[0]}</div>`
    +`<div style="font-weight:700;font-size:1rem;margin-bottom:8px;color:var(--text)">${m[1]}</div>`
    +`<div style="font-size:0.85rem;color:var(--text2);line-height:1.6">${m[2]}</div>`;
  const wc=document.querySelector('.welcome');
  if(wc)wc.after(closed);else document.querySelector('.wrap').prepend(closed);
}

// â”€â”€ SUBMIT NEW STUDENT (no email verification) â”€â”€
window.submitNew=async function(){
  const btn=document.getElementById('submitNewBtn');
  const lbl=document.getElementById('submit-label');
  const reset=()=>{btn.disabled=false;lbl.textContent=t('submit-label');};

  const name    = document.getElementById('nName').value.trim();
  const email   = document.getElementById('nEmail').value.trim().toLowerCase();
  const phone   = invitePhone ? normPhone(invitePhone) : normPhone(document.getElementById('nPhone').value.trim());
  const uni     = document.getElementById('nUni').value.trim();
  const year    = document.getElementById('nYear').value;
  const city    = document.getElementById('nCity').value.trim();
  const country = document.getElementById('nCountry').value.trim();
  hideMsg('newError');hideMsg('newSuccess');

  if(!name||!email||!phone||!uni||!year||!city){showMsg('newError',t('err-required'));return;}
  if(phone.replace(/[\s\+\-\(\)]/g,'').length<7){showMsg('newError',t('err-phone'));return;}
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){showMsg('newError',t('err-email'));return;}

  btn.disabled=true;lbl.textContent='...';

  // Duplicate check:
  // 1. registeredPhones â€” written by students on submit, public r/w, no personal data
  // 2. people â€” approved list, public read
  try{
    const phoneKey=phone.replace(/[^0-9]/g,'');
    const [regDoc, peopleSnap]=await Promise.all([
      db.doc('registeredPhones/'+phoneKey).get(),
      db.collection('people').get()
    ]);
    // Already in registeredPhones (submitted or approved)
    if(regDoc.exists){
      const src=regDoc.data().source||'';
      if(src==='pending'){showMsg('newError',t('err-pending'));reset();return;}
      showMsg('newError',t('err-duplicate-phone'));reset();return;
    }
    // Already in approved people list (phone or email)
    if(peopleSnap.docs.find(d=>normPhone(d.data().phone||'')===phone)){
      showMsg('newError',t('err-duplicate-phone'));reset();return;
    }
    if(email&&peopleSnap.docs.find(d=>(d.data().email||'').toLowerCase()===email)){
      showMsg('newError',t('err-duplicate-email'));reset();return;
    }
  }catch(e){
    showMsg('newError',t('err-connection')+e.message);reset();return;
  }

  // Submit directly to pending
  try{
    await db.collection('pending').add({
      name,email,phone,
      university:uni,yearOfStudy:year,city,country,
      fasting:fastOn,lang,
      status:'pending',
      submittedAt:ST(),submittedAtMs:Date.now(),
      source:'self-registration'
    });
    // Write phone to registeredPhones so future submissions are blocked
    // Rule: allow write: if true â€” contains only phone number, no personal data
    try{
      const phoneKey=phone.replace(/[^0-9]/g,'');
      await db.doc('registeredPhones/'+phoneKey).set({
        phone, source:'pending', addedAtMs:Date.now()
      });
    }catch(e){/* non-blocking â€” staff handles duplicates in dashboard */}
    if(inviteId){
      try{await db.doc('invites/'+inviteId).update({status:'used',usedAt:ST()});}catch(e){}
    }
    // Show success
    document.getElementById('newForm').classList.add('hidden');
    document.getElementById('pathSelector').classList.add('hidden');
    document.getElementById('successScreen').classList.remove('hidden');
    document.getElementById('successScreen').classList.add('show');
  }catch(e){
    showMsg('newError',e.code==='permission-denied'?t('err-permission'):t('err-generic')+e.message);
    reset();
  }
};

// â”€â”€ RETURNING STUDENT (phone lookup) â”€â”€
window.lookupPhone=async function(){
  const phone=normPhone(document.getElementById('rPhone').value.trim());
  if(!phone||phone.replace(/[^\d]/g,'').length<7){showMsg('retError',t('err-phone'));return;}
  const btn=document.getElementById('lookupBtn');
  btn.disabled=true;btn.querySelector('span').textContent='...';
  hideMsg('retError');
  try{
    const snap=await db.collection('people').get();
    const match=snap.docs.find(d=>normPhone(d.data().phone||'')===phone);
    if(match){
      const p=match.data();
      document.getElementById('pfName').textContent=p.name||'â€”';
      document.getElementById('pfDetails').textContent=(p.university||'')+(p.yearOfStudy?' Â· AnnÃ©e '+p.yearOfStudy:'');
      document.getElementById('profileFound').style.display='block';
      document.getElementById('profileFound').dataset.id=match.id;
      document.querySelectorAll('[id^="pf-"]:not(#profileFound)').forEach(el=>el.dataset.pid=match.id);
      // Pre-fill edit fields
      document.getElementById('eName').value=p.name||'';
      document.getElementById('eUni').value=p.university||'';
      document.getElementById('eYear').value=p.yearOfStudy||'1';
      document.getElementById('eCountry').value=p.country||'';
      document.getElementById('eCity').value=p.city||'';
      eFastOn=p.fasting||false;
      document.getElementById('eFastSw').classList.toggle('on',eFastOn);
      document.getElementById('eFastToggle').classList.toggle('on',eFastOn);
    }else{
      showMsg('retError',lang==='ar'?'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….':lang==='en'?'This number was not found in our list.':'Ce numÃ©ro n\'est pas dans notre liste.');
    }
  }catch(e){showMsg('retError','âš ï¸ Erreur: '+e.message);}
  btn.disabled=false;btn.querySelector('span').textContent=t('r-search-btn');
};

window.confirmProfile=function(){
  const pf=document.getElementById('profileFound');
  const pid=pf.dataset.id;
  // Mark as confirmed â€” for now just show success
  document.getElementById('returnForm').classList.add('hidden');
  document.getElementById('pathSelector').classList.add('hidden');
  document.getElementById('successScreen').classList.remove('hidden');
  document.getElementById('successScreen').classList.add('show');
};

let eFastOn=false;
window.toggleEditFast=function(){
  eFastOn=!eFastOn;
  document.getElementById('eFastSw').classList.toggle('on',eFastOn);
  document.getElementById('eFastToggle').classList.toggle('on',eFastOn);
};

window.editProfile=function(){
  document.getElementById('editFields').classList.remove('hidden');
};

window.submitEdit=async function(){
  const pf=document.getElementById('profileFound');
  const pid=pf.dataset.id;
  if(!pid){showMsg('retError','Erreur: profil introuvable.');return;}
  const btn=document.getElementById('e-save');
  btn.disabled=true;
  try{
    await db.collection('pending').add({
      type:'edit-request',
      personId:pid,
      name:document.getElementById('eName').value.trim(),
      university:document.getElementById('eUni').value.trim(),
      yearOfStudy:document.getElementById('eYear').value,
      country:document.getElementById('eCountry').value.trim(),
      city:document.getElementById('eCity').value.trim(),
      fasting:eFastOn,
      status:'pending',
      submittedAt:ST(),submittedAtMs:Date.now()
    });
    document.getElementById('returnForm').classList.add('hidden');
    document.getElementById('pathSelector').classList.add('hidden');
    document.getElementById('successScreen').classList.remove('hidden');
    document.getElementById('successScreen').classList.add('show');
  }catch(e){showMsg('retError','âš ï¸ Erreur: '+e.message);}
  btn.disabled=false;
};

window.resetPath=function(){
  window.selectPath(null);
  document.getElementById('profileFound').style.display='none';
  document.getElementById('editFields').classList.add('hidden');
  hideMsg('newError');hideMsg('newSuccess');hideMsg('retError');
};

// â”€â”€ INIT â”€â”€
checkRegistrationAccess().then(()=>{
  // Only show form if no closed screen was injected
  if(!document.querySelector('.closed-screen')){
    window.selectPath('new');
  }
}).catch(()=>{ window.selectPath('new'); });
</script>
</body>
</html>
