<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#080c14">
<title>Inscription ‚Äî Ramadan Food Aid</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Amiri:wght@400;700&display=swap');
:root{--bg:#080c14;--bg2:#0d1220;--surface:#111827;--surface2:#1a2438;--border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);--green:#22c55e;--green2:#16a34a;--green-dim:rgba(34,197,94,0.1);--gold:#f59e0b;--gold-dim:rgba(245,158,11,0.1);--danger:#ef4444;--danger-dim:rgba(239,68,68,0.1);--text:#f1f5f9;--text2:#94a3b8;--text3:#64748b}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:24px 16px 48px}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 30%,rgba(34,197,94,0.05) 0%,transparent 60%),radial-gradient(ellipse at 80% 70%,rgba(245,158,11,0.04) 0%,transparent 50%);pointer-events:none;z-index:0}
.wrap{max-width:520px;margin:0 auto;position:relative;z-index:1}

/* HEADER */
.hdr{text-align:center;margin-bottom:28px}
.moon{font-size:2.5rem;display:block;filter:drop-shadow(0 0 16px rgba(245,158,11,0.5));animation:float 3s ease-in-out infinite;margin-bottom:8px}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
.hdr-title{font-family:'Amiri',serif;font-size:1.6rem;font-weight:700;color:#f1f5f9;margin-bottom:4px}
.hdr-title span{color:var(--green)}
.hdr-ar{font-family:'Amiri',serif;font-size:0.95rem;color:var(--text3);direction:rtl;margin-bottom:16px}

/* LANG SWITCHER */
.lang-row{display:flex;gap:8px;justify-content:center;margin-bottom:24px}
.lang-btn{padding:6px 16px;border-radius:20px;border:1.5px solid var(--border2);background:var(--surface);color:var(--text2);font-family:'Space Grotesk',sans-serif;font-size:0.78rem;font-weight:600;cursor:pointer;transition:all 0.15s}
.lang-btn.active{background:var(--green);color:#fff;border-color:var(--green)}

/* WELCOME CARD */
.welcome{background:var(--green-dim);border:1px solid rgba(34,197,94,0.2);border-radius:14px;padding:16px 18px;margin-bottom:22px;font-size:0.88rem;color:var(--text2);line-height:1.7}
.welcome strong{color:var(--green);display:block;margin-bottom:6px;font-size:0.95rem}

/* PATH SELECTOR */
.path-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px}
.path-card{background:var(--surface);border:2px solid var(--border2);border-radius:14px;padding:18px 14px;text-align:center;cursor:pointer;transition:all 0.2s}
.path-card:hover{border-color:var(--green);background:var(--green-dim)}
.path-card.selected{border-color:var(--green);background:var(--green-dim)}
.path-icon{font-size:2rem;display:block;margin-bottom:8px}
.path-title{font-size:0.9rem;font-weight:700;margin-bottom:4px}
.path-sub{font-size:0.72rem;color:var(--text3);line-height:1.4}

/* FORM CARD */
.fcard{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:24px;position:relative;overflow:hidden}
.fcard::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--green),transparent)}
.fcard-title{font-size:1rem;font-weight:700;margin-bottom:18px;color:var(--text)}

.field{margin-bottom:14px}
.field label{display:block;font-size:0.7rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px}
.fi{width:100%;background:var(--bg2);border:1px solid var(--border2);border-radius:10px;color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:0.92rem;padding:12px 14px;outline:none;transition:border-color 0.2s,box-shadow 0.2s}
.fi:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
.fi::placeholder{color:var(--text3)}
select.fi{cursor:pointer}
select.fi option{background:var(--surface)}

/* FASTING TOGGLE */
.fast-toggle{display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1.5px solid var(--border2);border-radius:12px;padding:13px 16px;cursor:pointer;transition:all 0.2s;margin-bottom:14px}
.fast-toggle.on{border-color:rgba(34,197,94,0.4);background:var(--green-dim)}
.fast-toggle-info{font-size:0.9rem;font-weight:600}
.fast-toggle-sub{font-size:0.72rem;color:var(--text3);margin-top:2px}
.sw{width:40px;height:22px;background:var(--surface2);border-radius:11px;position:relative;transition:background 0.2s;flex-shrink:0}
.sw.on{background:var(--green)}
.sw::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.3)}
.sw.on::after{transform:translateX(18px)}

/* VERIFY CARD */
.verify-card{display:none}
.verify-card.show{display:block}
.vphone-row{display:flex;gap:8px;margin-bottom:16px}
.vphone-row .fi{flex:1}
.vbtn{padding:12px 18px;background:var(--green);color:#fff;border:none;border-radius:10px;font-family:'Space Grotesk',sans-serif;font-size:0.88rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 0.15s;flex-shrink:0}
.vbtn:hover{background:var(--green2)}
.vbtn:disabled{background:var(--surface2);color:var(--text3);cursor:not-allowed}

/* FOUND PROFILE */
.profile-found{background:var(--green-dim);border:1.5px solid rgba(34,197,94,0.3);border-radius:14px;padding:18px;margin-bottom:16px;display:none}
.profile-found.show{display:block}
.pf-label{font-size:0.68rem;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px}
.pf-name{font-size:1.1rem;font-weight:700;margin-bottom:4px}
.pf-details{font-size:0.82rem;color:var(--text2);line-height:1.6}
.pf-actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}

/* SUBMIT BTN */
.submit-btn{width:100%;padding:14px;background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;border:none;border-radius:12px;font-family:'Space Grotesk',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:6px;letter-spacing:0.2px}
.submit-btn:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(34,197,94,0.3)}
.submit-btn:active{transform:scale(0.98)}
.submit-btn:disabled{background:var(--surface2);color:var(--text3);cursor:not-allowed;transform:none;box-shadow:none}

/* ERROR / SUCCESS */
.ebox{background:var(--danger-dim);border:1px solid var(--danger);border-radius:8px;padding:10px 14px;font-size:0.83rem;color:var(--danger);margin-bottom:14px;display:none}
.sbox{background:var(--green-dim);border:1px solid var(--green);border-radius:8px;padding:10px 14px;font-size:0.83rem;color:var(--green);margin-bottom:14px;display:none}

/* SUCCESS SCREEN */
.success-screen{display:none;text-align:center;padding:40px 20px}
.success-screen.show{display:block}
.success-icon{font-size:4rem;margin-bottom:16px;animation:pop 0.4s ease}
@keyframes pop{0%{transform:scale(0)}80%{transform:scale(1.1)}100%{transform:scale(1)}}
.success-title{font-family:'Amiri',serif;font-size:1.5rem;font-weight:700;color:var(--green);margin-bottom:8px}
.success-sub{font-size:0.9rem;color:var(--text2);line-height:1.6;max-width:340px;margin:0 auto}
.pending-badge{display:inline-flex;align-items:center;gap:6px;background:var(--gold-dim);border:1px solid rgba(245,158,11,0.3);border-radius:20px;padding:6px 14px;font-size:0.78rem;font-weight:600;color:var(--gold);margin-top:14px}

/* FOOTER */
.footer{text-align:center;margin-top:28px;font-family:'Amiri',serif;font-size:0.82rem;color:rgba(201,168,76,0.3);letter-spacing:1px}

.hidden{display:none!important}
.btn-outline{padding:8px 16px;border-radius:8px;border:1.5px solid var(--border2);background:transparent;color:var(--text2);font-family:'Space Grotesk',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.15s}
.btn-outline:hover{border-color:var(--green);color:var(--green)}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="hdr">
    <span class="moon">üåô</span>
    <div class="hdr-title">Ramadan <span>Food Aid</span></div>
    <div class="hdr-ar">ŸÖÿ≥ÿßÿπÿØÿßÿ™ ÿ±ŸÖÿ∂ÿßŸÜ ÿßŸÑÿ∫ÿ∞ÿßÿ¶Ÿäÿ©</div>
  </div>

  <!-- LANG SWITCHER -->
  <div class="lang-row">
    <button class="lang-btn active" onclick="setLang('fr')">üá´üá∑ Fran√ßais</button>
    <button class="lang-btn" onclick="setLang('ar')">üá≤üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
    <button class="lang-btn" onclick="setLang('en')">üá¨üáß English</button>
  </div>

  <!-- WELCOME MESSAGE -->
  <div class="welcome">
    <strong id="w-title">üåô Un mot avant de commencer</strong>
    <span id="w-body">Nous savons que votre temps est pr√©cieux et nous vous remercions de votre patience. Nous travaillons sur un syst√®me permanent pour que vous n'ayez plus jamais √† faire cela. Pour l'instant, cette inscription unique nous aide √† garantir que chacun re√ßoit ce qu'il m√©rite ‚Äî rapidement et √©quitablement. Merci de faire partie de cette communaut√©. üåô</span>
  </div>

  <!-- PATH SELECTOR hidden - auto new student -->
  <div class="path-row" id="pathSelector" style="display:none">
    <div class="path-card selected" id="pathNew">
      <span class="path-icon">‚ú®</span>
      <div class="path-title" id="p-new-title">Nouveau</div>
      <div class="path-sub" id="p-new-sub">Je n'ai jamais rempli ce formulaire</div>
    </div>
    <div class="path-card" id="pathReturn" style="display:none"></div>
  </div>

  <!-- NEW STUDENT FORM -->
  <div class="fcard hidden" id="newForm">
    <div class="fcard-title" id="f-title">üìù Inscription</div>
    <div class="ebox" id="newError"></div>
    <div class="sbox" id="newSuccess"></div>

    <div class="field">
      <label id="l-name">Nom complet</label>
      <input type="text" class="fi" id="nName" placeholder="Ahmed Benali"/>
    </div>
    <div class="field">
      <label id="l-email">Adresse e-mail</label>
      <input type="email" class="fi" id="nEmail" placeholder="ahmed@email.com"/>
    </div>
    <div class="field">
      <label id="l-phone">Num√©ro de t√©l√©phone</label>
      <input type="tel" class="fi" id="nPhone" placeholder="+212601234567"/>
    </div>

    <div class="field">
      <label id="l-uni">Universit√© / √âcole</label>
      <input type="text" class="fi" id="nUni" placeholder="Facult√© de M√©decine..."/>
    </div>
    <div class="field">
      <label id="l-year">Ann√©e d'√©tudes</label>
      <select class="fi" id="nYear">
        <option value="" id="y-placeholder">S√©lectionner...</option>
        <option value="1">1√®re ann√©e</option>
        <option value="2">2√®me ann√©e</option>
        <option value="3">3√®me ann√©e</option>
        <option value="4">4√®me ann√©e</option>
        <option value="5">5√®me ann√©e</option>
        <option value="6">6√®me ann√©e</option>
        <option value="7">7√®me ann√©e / Master</option>
        <option value="other">Autre</option>
      </select>
    </div>
    <div class="field">
      <label id="l-country">Pays d'origine / Country of origin / ÿ®ŸÑÿØ ÿßŸÑÿ£ÿµŸÑ</label>
      <input type="text" class="fi" id="nCountry" placeholder="Maroc / Morocco / ÿßŸÑŸÖÿ∫ÿ±ÿ®"/>
    </div>
    <div class="field">
      <label id="l-city">Ville actuelle / Current city / ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©</label>
      <input type="text" class="fi" id="nCity" placeholder="Casablanca"/>
    </div>

    <div class="fast-toggle" id="nFastToggle" onclick="toggleFast()">
      <div>
        <div class="fast-toggle-info" id="l-fast">üåô Je suis en train de je√ªner (Ramadan)</div>
        <div class="fast-toggle-sub" id="l-fast-sub">Cochez si vous √™tes musulman et que vous je√ªnez</div>
      </div>
      <div class="sw" id="fastSw"></div>
    </div>

    <button class="submit-btn" id="submitNewBtn" onclick="sendVerifyCode()">
      <span id="submit-label">Envoyer le code de v√©rification ‚Üí</span>
    </button>

    <!-- EMAIL VERIFICATION PANEL (shown after link is sent) -->
    <div class="verify-card" id="verifyPanel">
      <div style="text-align:center;padding:24px 16px">
        <div style="font-size:3rem;margin-bottom:12px">üì¨</div>
        <div style="font-size:1rem;font-weight:700;color:var(--text);margin-bottom:8px" id="vcode-sent-msg">V√©rifiez votre bo√Æte mail</div>
        <div style="font-size:0.82rem;color:var(--text2);line-height:1.6" id="vcode-sent-sub">
          Nous vous avons envoy√© un lien de v√©rification.<br/>
          Cliquez sur le lien dans l'email pour confirmer votre inscription.
        </div>
        <div style="margin-top:16px;padding:10px 14px;background:var(--bg2);border-radius:8px;font-size:0.75rem;color:var(--text3)">
          üí° V√©rifiez aussi vos spams si vous ne voyez pas l'email
        </div>
      </div>
      <div class="ebox" id="verifyError"></div>
      <div style="margin-top:4px;text-align:center">
        <button class="btn-outline" id="resendBtn" onclick="resendCode()" style="font-size:0.78rem"><span id="resend-btn">üîÑ Renvoyer le lien</span></button>
      </div>
    </div>

    <div style="margin-top:12px;text-align:center">
      <button class="btn-outline" onclick="resetPath()" id="back-btn">‚Üê Retour</button>
    </div>
  </div>

  <!-- RETURNING STUDENT -->
  <div class="fcard hidden" id="returnForm">
    <div class="fcard-title" id="r-title">üîÑ V√©rification</div>
    <div class="ebox" id="retError"></div>

    <p style="font-size:0.85rem;color:var(--text2);margin-bottom:14px" id="r-sub">Entrez votre num√©ro de t√©l√©phone pour retrouver votre profil.</p>

    <div class="vphone-row">
      <input type="tel" class="fi" id="rPhone" placeholder="+212601234567" onkeydown="if(event.key==='Enter')lookupPhone()"/>
      <button class="vbtn" id="lookupBtn" onclick="lookupPhone()"><span id="r-search-btn">Rechercher</span></button>
    </div>

    <!-- PROFILE FOUND -->
    <div class="profile-found" id="profileFound">
      <div class="pf-label" id="pf-label">C'est vous ?</div>
      <div class="pf-name" id="pfName">‚Äî</div>
      <div class="pf-details" id="pfDetails">‚Äî</div>
      <div class="pf-actions">
        <button class="submit-btn" style="width:auto;padding:10px 20px" onclick="confirmProfile()" id="pf-yes">‚úÖ Oui, c'est moi</button>
        <button class="btn-outline" onclick="editProfile()" id="pf-fix">‚úèÔ∏è Corriger</button>
      </div>
    </div>

    <!-- EDIT FIELDS (shown if they want to fix) -->
    <div class="hidden" id="editFields">
      <div style="margin-bottom:14px;font-size:0.83rem;color:var(--text2)" id="e-sub">Corrigez les informations incorrectes :</div>
      <div class="field"><label id="el-name">Nom complet</label><input type="text" class="fi" id="eName" placeholder="Nom complet"/></div>
      <div class="field"><label id="el-uni">Universit√©</label><input type="text" class="fi" id="eUni" placeholder="Universit√©..."/></div>
      <div class="field"><label id="el-year">Ann√©e d'√©tudes</label>
        <select class="fi" id="eYear">
          <option value="1">1√®re ann√©e</option><option value="2">2√®me ann√©e</option><option value="3">3√®me ann√©e</option>
          <option value="4">4√®me ann√©e</option><option value="5">5√®me ann√©e</option><option value="6">6√®me ann√©e</option>
          <option value="7">7√®me ann√©e / Master</option><option value="other">Autre</option>
        </select>
      </div>
      <div class="field"><label id="el-country">Pays d'origine / Country</label><input type="text" class="fi" id="eCountry" placeholder="Maroc / Morocco..."/></div>
      <div class="field"><label id="el-city">Ville actuelle / City</label><input type="text" class="fi" id="eCity" placeholder="Casablanca..."/></div>
      <div class="fast-toggle" id="eFastToggle" onclick="toggleEditFast()">
        <div><div class="fast-toggle-info" id="el-fast">üåô Je je√ªne (Ramadan)</div></div>
        <div class="sw" id="eFastSw"></div>
      </div>
      <button class="submit-btn" onclick="submitEdit()" id="e-save">üíæ Sauvegarder les modifications</button>
    </div>

    <div style="margin-top:12px;text-align:center">
      <button class="btn-outline" onclick="resetPath()" id="back-btn2">‚Üê Retour</button>
    </div>
  </div>

  <!-- SUCCESS SCREEN -->
  <div class="success-screen" id="successScreen">
    <div class="success-icon">üéâ</div>
    <div class="success-title" id="s-title">Demande envoy√©e !</div>
    <div class="success-sub" id="s-body">Votre demande a √©t√© re√ßue et sera v√©rifi√©e par notre √©quipe. Vous serez ajout√© √† la liste d√®s validation. Merci pour votre patience ! üåô</div>
    <div class="pending-badge" id="s-badge">‚è≥ En attente de validation</div>
  </div>

  <div class="footer">ÿ±ŸÖÿ∂ÿßŸÜ ŸÉÿ±ŸäŸÖ ‚ú¶ Ramadan Kareem ‚ú¶ Ramadan Moubarak</div>
</div>
<div class="toast" id="regToast" style="position:fixed;bottom:28px;right:28px;background:#1e2d42;color:#f1f5f9;padding:12px 20px;border-radius:12px;font-size:0.86rem;font-weight:600;border:1px solid rgba(255,255,255,0.12);box-shadow:0 8px 30px rgba(0,0,0,0.4);opacity:0;transform:translateY(10px);transition:all 0.3s;pointer-events:none;z-index:9999;max-width:320px"></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import{getAuth,sendSignInLinkToEmail,isSignInWithEmailLink,signInWithEmailLink}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import{getFirestore,collection,addDoc,getDocs,getDoc,doc,updateDoc,serverTimestamp}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const FC={apiKey:"AIzaSyB_SeMMk-2mL_XYTKEemoIeh_j2odQ6LNk",authDomain:"ramadan-food-aid.firebaseapp.com",projectId:"ramadan-food-aid",storageBucket:"ramadan-food-aid.firebasestorage.app",messagingSenderId:"836613630009",appId:"1:836613630009:web:c5b3047298224ec82f05e8"};
const app=initializeApp(FC);const auth=getAuth(app);const db=getFirestore(app);

// Phone normalizer ‚Äî strips spaces, fixes +212 prefix variants
function normPhone(p){
  let n=String(p||'').replace(/[\s\-\.\(\)]/g,'');
  if(n.startsWith('00212'))n='+212'+n.slice(5);
  if(n.startsWith('212')&&!n.startsWith('+'))n='+212'+n.slice(3);
  if(n.startsWith('0')&&n.length===10)n='+212'+n.slice(1);
  // 9-digit number without any prefix ‚Üí assume Moroccan (+212)
  // Moroccan mobiles start with 6, 7 or 5
  if(/^[6-7]\d{8}$/.test(n))n='+212'+n;
  return n;
}

// Auth ready ‚Äî always true now (no anon sign-in needed)
let authReady=false;
function enableButtons(){
  authReady=true;
  document.querySelectorAll('.submit-btn,.vbtn,.path-card').forEach(b=>{
    b.style.opacity='1';b.style.pointerEvents='auto';
  });
}

// ‚îÄ‚îÄ HANDLE EMAIL LINK RETURN ‚îÄ‚îÄ
// When student clicks the Firebase email link, they land back here
(async()=>{
  if(isSignInWithEmailLink(auth, window.location.href)){
    const savedEmail = localStorage.getItem('sofra_verify_email');
    const savedData  = localStorage.getItem('sofra_form_data');
    const savedInvite= localStorage.getItem('sofra_invite_id');
    if(!savedEmail || !savedData){
      // Missing saved data - show error
      document.body.innerHTML=`<div style="text-align:center;padding:60px 20px;font-family:sans-serif;color:#f1f5f9;background:#080c14;min-height:100vh">
        <div style="font-size:3rem;margin-bottom:16px">‚ö†Ô∏è</div>
        <div style="font-size:1.2rem;margin-bottom:8px">Lien expir√© ou invalide</div>
        <div style="color:#64748b;margin-bottom:24px">Veuillez recommencer l'inscription.</div>
        <a href="register.html" style="color:#c9a84c">‚Üê R√©essayer</a>
      </div>`;
      return;
    }
    try {
      // Complete sign-in with the email link
      await signInWithEmailLink(auth, savedEmail, window.location.href);
      // Clean URL (remove Firebase oob params)
      window.history.replaceState({},'',window.location.pathname+(savedInvite?'?invite='+savedInvite:''));
      // Get saved form data
      const fd = JSON.parse(savedData);
      // Submit to pending
      await addDoc(collection(db,'pending'),{
        name:fd.name, email:fd.email, phone:fd.phone,
        university:fd.uni, yearOfStudy:fd.year, city:fd.city, country:fd.country,
        fasting:fd.fasting, lang:fd.lang,
        status:'pending',
        submittedAt:serverTimestamp(), submittedAtMs:Date.now(),
        verified:true, emailVerified:true,
        source:'self-registration'
      });
      // Mark invite used
      if(savedInvite){
        try{ await updateDoc(doc(db,'invites',savedInvite),{status:'used',usedAt:serverTimestamp()}); }catch(e){}
      }
      // Clear storage
      localStorage.removeItem('sofra_verify_email');
      localStorage.removeItem('sofra_form_data');
      localStorage.removeItem('sofra_invite_id');
      // Show success screen
      document.querySelector('.wrap').innerHTML=`<div style="text-align:center;padding:60px 20px">
        <div style="font-size:3.5rem;margin-bottom:16px;animation:pop 0.4s ease">üéâ</div>
        <div style="font-family:'Amiri',serif;font-size:1.5rem;color:#22c55e;margin-bottom:8px">Inscription confirm√©e !</div>
        <div style="color:#94a3b8;font-size:0.92rem;line-height:1.7;margin-bottom:24px">
          Votre email a √©t√© v√©rifi√© et votre inscription a √©t√© soumise.<br/>
          Notre √©quipe va examiner votre dossier. Ramadan Mubarak üåô
        </div>
        <a href="landing.html" style="color:#c9a84c;font-weight:600;font-size:0.9rem">‚Üê Retour √† l'accueil</a>
      </div>`;
    } catch(err) {
      console.error('Email link sign-in error:', err);
      document.body.innerHTML=`<div style="text-align:center;padding:60px 20px;font-family:sans-serif;color:#f1f5f9;background:#080c14;min-height:100vh">
        <div style="font-size:3rem;margin-bottom:16px">‚ùå</div>
        <div style="font-size:1.2rem;margin-bottom:8px">Erreur de v√©rification</div>
        <div style="color:#64748b;margin-bottom:24px">${err.message}</div>
        <a href="register.html" style="color:#c9a84c">‚Üê R√©essayer</a>
      </div>`;
    }
    return; // Stop normal page init
  }
  // Normal page load
  enableButtons();
  checkRegistrationAccess().then(()=>{ window.selectPath('new'); }).catch(()=>{ window.selectPath('new'); });
})();

// Check registration status and invite token
let inviteId=null;
let invitePhone=null;

async function checkRegistrationAccess(){
  const params=new URLSearchParams(window.location.search);
  const invId=params.get('invite');

  // ALWAYS require a valid invite link ‚Äî no open registration
  if(!invId){
    showClosedScreen('üîí Lien requis', 'Cette page est uniquement accessible via un lien d'invitation personnel. Veuillez contacter l'administration pour en obtenir un.');
    return;
  }

  if(invId){
    // Invite link ‚Äî validate it regardless of reg open/closed
    try {
      const invSnap=await getDoc(doc(db,'invites',invId));
      if(!invSnap.exists()){
        showClosedScreen('‚ùå Invalid Link', 'This invitation link is not valid.');
        return;
      }
      const inv=invSnap.data();
      if(inv.status==='used'){
        showClosedScreen('‚úÖ Already Registered', 'This invitation link has already been used to complete a registration.');
        return;
      }
      if(inv.status==='revoked'){
        showClosedScreen('‚ùå Link Revoked', 'This invitation link has been revoked. Please contact the admin.');
        return;
      }
      if(inv.expiresAtMs<Date.now()){
        showClosedScreen('‚è∞ Link Expired', 'This invitation link has expired (valid for 24 hours). Please ask for a new one.');
        return;
      }
      // Valid invite ‚Äî pre-fill phone and lock it
      inviteId=invId;
      invitePhone=inv.phone||'';
      const phoneInput=document.getElementById('nPhone');
      if(phoneInput){
        phoneInput.value=invitePhone;
        phoneInput.readOnly=true;
        phoneInput.style.opacity='0.7';
        phoneInput.style.cursor='not-allowed';
      }
      // Auto-open the new student form
      window.selectPath('new');
      // Show a welcome banner
      const banner=document.createElement('div');
      banner.style.cssText='background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-size:0.82rem;color:var(--green)';
      banner.innerHTML='‚úÖ <strong>Personal invitation</strong> ‚Äî your phone number is pre-filled and verified.';
      const form=document.getElementById('newForm');
      if(form)form.insertBefore(banner,form.firstChild);
    } catch(e){
      showClosedScreen('‚ùå Error', 'Could not validate your invitation link. Please try again.');
    }
    return;
  }

  // No invite ‚Äî check if registration is open
  // Registration always invite-only
}

function showClosedScreen(title, message){
  document.getElementById('pathSelector').classList.add('hidden');
  const closed=document.createElement('div');
  closed.style.cssText='text-align:center;padding:40px 20px';
  closed.innerHTML=`
    <div style="font-size:3rem;margin-bottom:16px">${title.split(' ')[0]}</div>
    <div style="font-size:1.2rem;font-weight:700;color:var(--text1);margin-bottom:8px">${title.split(' ').slice(1).join(' ')}</div>
    <div style="font-size:0.9rem;color:var(--text3);max-width:320px;margin:0 auto;line-height:1.6">${message}</div>
  `;
  document.querySelector('.welcome-card')?.after(closed);
}
function disableButtons(){
  document.querySelectorAll('.submit-btn,.vbtn').forEach(b=>{
    b.style.opacity='0.5';b.style.pointerEvents='none';
  });
}

// No auth needed - Firestore rules handle access
enableButtons();
checkRegistrationAccess().then(()=>{ window.selectPath('new'); }).catch(()=>{ window.selectPath('new'); });

let lang='fr';let fastOn=false;let eFastOn=false;let foundPerson=null;

// ‚îÄ‚îÄ TRANSLATIONS ‚îÄ‚îÄ
const T={
  fr:{
    'w-title':'üåô Un mot avant de commencer',
    'w-body':"Nous savons que votre temps est pr√©cieux et nous vous remercions de votre patience. Nous travaillons sur un syst√®me permanent pour que vous n'ayez plus jamais √† faire cela. Pour l'instant, cette inscription unique nous aide √† garantir que chacun re√ßoit ce qu'il m√©rite ‚Äî rapidement et √©quitablement. Merci de faire partie de cette communaut√©. üåô",
    'p-new-title':'Nouveau','p-new-sub':"Je n'ai jamais rempli ce formulaire",
    'p-ret-title':'D√©j√† inscrit','p-ret-sub':"J'ai d√©j√† donn√© mes informations",
    'f-title':'üìù Inscription',
    'l-name':'Nom complet','l-email':'Adresse e-mail','l-phone':'Num√©ro de t√©l√©phone','l-uni':'Universit√© / √âcole',
    'l-year':"Ann√©e d'√©tudes",'l-city':"Ville / Pays d'origine",
    'l-fast':'üåô Je suis en train de je√ªner (Ramadan)','l-fast-sub':'Cochez si vous √™tes musulman et que vous je√ªnez',
    'submit-label':'Envoyer le code de v√©rification ‚Üí',
    'verify-submit-label':'‚úÖ V√©rifier et envoyer',
    'l-vcode':'Code de v√©rification',
    'vcode-sent-msg':'üìß Code envoy√© !',
    'vcode-sent-sub':'Entrez le code √† 6 chiffres re√ßu par e-mail.',
    'resend-btn':'üîÑ Renvoyer le code',
    'back-btn':'‚Üê Retour','back-btn2':'‚Üê Retour',
    'r-title':'üîÑ V√©rification','r-sub':'Entrez votre num√©ro de t√©l√©phone pour retrouver votre profil.',
    'r-search-btn':'Rechercher','pf-label':"C'est vous ?",
    'pf-yes':'‚úÖ Oui, c\'est moi','pf-fix':'‚úèÔ∏è Corriger',
    'e-sub':'Corrigez les informations incorrectes :',
    'el-name':'Nom complet','el-uni':'Universit√©','el-year':"Ann√©e d'√©tudes",'el-country':"Pays d'origine",'el-city':'Ville actuelle','el-fast':'üåô Je je√ªne (Ramadan)',
    'e-save':'üíæ Sauvegarder les modifications',
    's-title':'Demande envoy√©e !','s-body':"Votre demande a √©t√© re√ßue et sera v√©rifi√©e par notre √©quipe. Vous serez ajout√© √† la liste d√®s validation. Merci pour votre patience ! üåô",
    's-badge':'‚è≥ En attente de validation',
    'err-required':'Veuillez remplir tous les champs obligatoires.',
    'err-phone':'Num√©ro de t√©l√©phone invalide.',
    'err-email':'Adresse e-mail invalide.',
    'err-code':'Code incorrect ou expir√©. Veuillez r√©essayer.',
    'err-notfound':'Num√©ro non trouv√©. √ätes-vous nouveau ? Choisissez "Nouveau" pour vous inscrire.',
    'err-duplicate':'Ce num√©ro est d√©j√† inscrit.',
    'ok-verified':'Profil v√©rifi√© avec succ√®s ! üéâ',
    'ok-updated':'Informations mises √† jour ! Elles seront v√©rifi√©es par notre √©quipe.',
  },
  ar:{
    'w-title':'üåô ŸÉŸÑŸÖÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ®ÿØÿßŸäÿ©',
    'w-body':'ŸÜÿπŸÑŸÖ ÿ£ŸÜ ŸàŸÇÿ™ŸÉŸÖ ÿ´ŸÖŸäŸÜ ŸàŸÜÿ¥ŸÉÿ±ŸÉŸÖ ÿπŸÑŸâ ÿµÿ®ÿ±ŸÉŸÖ. ŸÜÿ≠ŸÜ ŸÜÿπŸÖŸÑ ÿπŸÑŸâ ŸÜÿ∏ÿßŸÖ ÿØÿßÿ¶ŸÖ ÿ≠ÿ™Ÿâ ŸÑÿß ÿ™ÿ∂ÿ∑ÿ±Ÿàÿß ŸÑŸÅÿπŸÑ Ÿáÿ∞ÿß ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ. ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿå Ÿäÿ≥ÿßÿπÿØŸÜÿß Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÑŸâ ÿ∂ŸÖÿßŸÜ ÿ≠ÿµŸàŸÑ ÿßŸÑÿ¨ŸÖŸäÿπ ÿπŸÑŸâ ŸÖÿß Ÿäÿ≥ÿ™ÿ≠ŸÇ ‚Äî ÿ®ÿ≥ÿ±ÿπÿ© Ÿàÿ®ÿπÿØÿßŸÑÿ©. ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉŸàŸÜŸÉŸÖ ÿ¨ÿ≤ÿ°ÿßŸã ŸÖŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¨ÿ™ŸÖÿπ. üåô',
    'p-new-title':'ÿ¨ÿØŸäÿØ','p-new-sub':'ŸÑŸÖ ÿ£ÿ≥ÿ¨ŸÑ ŸÖŸÜ ŸÇÿ®ŸÑ',
    'p-ret-title':'ŸÖÿ≥ÿ¨ŸÑ ŸÖÿ≥ÿ®ŸÇÿßŸã','p-ret-sub':'ŸÇÿØŸÖÿ™ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿä ŸÖŸÜ ŸÇÿ®ŸÑ',
    'f-title':'üìù ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ',
    'l-name':'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ','l-email':'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä','l-phone':'ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ','l-uni':'ÿßŸÑÿ¨ÿßŸÖÿπÿ© / ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©',
    'l-year':'ÿ≥ŸÜÿ© ÿßŸÑÿØÿ±ÿßÿ≥ÿ©','l-city':'ÿßŸÑŸÖÿØŸäŸÜÿ© / ÿßŸÑÿ®ŸÑÿØ ÿßŸÑÿ£ÿµŸÑŸä',
    'l-fast':'üåô ÿ£ŸÜÿß ÿµÿßÿ¶ŸÖ (ÿ±ŸÖÿ∂ÿßŸÜ)','l-fast-sub':'ÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ŸÖÿ≥ŸÑŸÖÿßŸã Ÿàÿµÿßÿ¶ŸÖÿßŸã',
    'submit-label':'ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ‚Üê',
    'verify-submit-label':'‚úÖ ÿ™ÿ≠ŸÇŸÇ Ÿàÿ£ÿ±ÿ≥ŸÑ',
    'l-vcode':'ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ',
    'vcode-sent-msg':'üìß ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ŸÖÿ≤!',
    'vcode-sent-sub':'ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÖÿ≤ ÿßŸÑŸÖŸÉŸàŸÜ ŸÖŸÜ 6 ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸÖŸèÿ±ÿ≥ŸÑ ÿ•ŸÑŸâ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä.',
    'resend-btn':'üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ',
    'back-btn':'‚Üí ÿ±ÿ¨Ÿàÿπ','back-btn2':'‚Üí ÿ±ÿ¨Ÿàÿπ',
    'r-title':'üîÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ','r-sub':'ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅŸÉ ŸÑŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÑŸÅŸÉ ÿßŸÑÿ¥ÿÆÿµŸä.',
    'r-search-btn':'ÿ®ÿ≠ÿ´','pf-label':'ŸáŸÑ Ÿáÿ∞ÿß ÿ£ŸÜÿ™ÿü',
    'pf-yes':'‚úÖ ŸÜÿπŸÖÿå Ÿáÿ∞ÿß ÿ£ŸÜÿß','pf-fix':'‚úèÔ∏è ÿ™ÿµÿ≠Ÿäÿ≠',
    'e-sub':'ÿµÿ≠ÿ≠ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿÆÿßÿ∑ÿ¶ÿ©:',
    'el-name':'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ','el-uni':'ÿßŸÑÿ¨ÿßŸÖÿπÿ©','el-year':'ÿ≥ŸÜÿ© ÿßŸÑÿØÿ±ÿßÿ≥ÿ©','el-country':'ÿ®ŸÑÿØ ÿßŸÑÿ£ÿµŸÑ','el-city':'ÿßŸÑŸÖÿØŸäŸÜÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©','el-fast':'üåô ÿ£ŸÜÿß ÿµÿßÿ¶ŸÖ (ÿ±ŸÖÿ∂ÿßŸÜ)',
    'e-save':'üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™',
    's-title':'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®!','s-body':'ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ®ŸÉ Ÿàÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜŸá ŸÖŸÜ ŸÇÿ®ŸÑ ŸÅÿ±ŸäŸÇŸÜÿß. ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ™ŸÉ ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ. ÿ¥ŸÉÿ±ÿßŸã ÿπŸÑŸâ ÿµÿ®ÿ±ŸÉ! üåô',
    's-badge':'‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÇŸÇ',
    'err-required':'Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©.','err-phone':'ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠.',
    'err-email':'ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠.',
    'err-code':'ÿßŸÑÿ±ŸÖÿ≤ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ¨ÿØÿØÿßŸã.',
    'err-notfound':'ÿßŸÑÿ±ŸÇŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ. ŸáŸÑ ÿ£ŸÜÿ™ ÿ¨ÿØŸäÿØÿü ÿßÿÆÿ™ÿ± "ÿ¨ÿØŸäÿØ" ŸÑŸÑÿ™ÿ≥ÿ¨ŸäŸÑ.','err-duplicate':'Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÇŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ.',
    'ok-verified':'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ÿ®ŸÜÿ¨ÿßÿ≠! üéâ','ok-updated':'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™! ÿ≥Ÿäÿ™ŸÖ ŸÖÿ±ÿßÿ¨ÿπÿ™Ÿáÿß ŸÖŸÜ ŸÇÿ®ŸÑ ŸÅÿ±ŸäŸÇŸÜÿß.',
  },
  en:{
    'w-title':'üåô A word before we start',
    'w-body':"We know your time is valuable and we appreciate your patience. We're working on a permanent system so you never have to do this again. For now, this one-time registration helps us ensure everyone gets what they deserve ‚Äî quickly and fairly. Thank you for being part of this community. üåô",
    'p-new-title':'New Student','p-new-sub':"I've never filled this form before",
    'p-ret-title':'Already Registered','p-ret-sub':"I've already given my information",
    'f-title':'üìù Registration',
    'l-name':'Full Name','l-email':'Email Address','l-phone':'Phone Number','l-uni':'University / School',
    'l-year':'Year of Study','l-city':'City / Country of Origin',
    'l-fast':'üåô I am fasting (Ramadan)','l-fast-sub':'Check if you are Muslim and fasting',
    'submit-label':'Send Verification Code ‚Üí',
    'verify-submit-label':'‚úÖ Verify & Submit',
    'l-vcode':'Verification Code',
    'vcode-sent-msg':'üìß Code sent!',
    'vcode-sent-sub':'Enter the 6-digit code sent to your email.',
    'resend-btn':'üîÑ Resend code',
    'back-btn':'‚Üê Back','back-btn2':'‚Üê Back',
    'r-title':'üîÑ Verification','r-sub':'Enter your phone number to find your profile.',
    'r-search-btn':'Search','pf-label':'Is this you?',
    'pf-yes':"‚úÖ Yes, that's me",'pf-fix':'‚úèÔ∏è Fix info',
    'e-sub':'Correct the wrong information:',
    'el-name':'Full Name','el-uni':'University','el-year':'Year of Study','el-country':'Country of Origin','el-city':'Current City','el-fast':'üåô I am fasting (Ramadan)',
    'e-save':'üíæ Save Changes',
    's-title':'Request Submitted!','s-body':"Your request has been received and will be verified by our team. You'll be added to the list once approved. Thank you for your patience! üåô",
    's-badge':'‚è≥ Pending verification',
    'err-required':'Please fill in all required fields.','err-phone':'Invalid phone number.',
    'err-email':'Invalid email address.',
    'err-code':'Incorrect or expired code. Please try again.',
    'err-notfound':'Number not found. Are you new? Choose "New Student" to register.','err-duplicate':'This number is already registered.',
    'ok-verified':'Profile verified successfully! üéâ','ok-updated':'Information updated! It will be reviewed by our team.',
  }
};

function t(key){return(T[lang]&&T[lang][key])||T['fr'][key]||key;}

window.setLang=l=>{
  lang=l;
  document.querySelectorAll('.lang-btn').forEach((b,i)=>{b.classList.toggle('active',['fr','ar','en'][i]===l);});
  document.documentElement.dir=l==='ar'?'rtl':'ltr';
  // Update all text
  Object.keys(T.fr).forEach(key=>{
    const el=document.getElementById(key);
    if(el)el.textContent=t(key);
  });
  // Update year select placeholder
  const yp=document.getElementById('y-placeholder');
  if(yp)yp.textContent=l==='ar'?'ÿßÿÆÿ™ÿ±...':l==='en'?'Select...':'S√©lectionner...';
};

window.selectPath=path=>{
  document.getElementById('newForm').classList.toggle('hidden',path!=='new');
  document.getElementById('returnForm').classList.toggle('hidden',path!=='return');
  document.getElementById('pathNew').classList.toggle('selected',path==='new');
  document.getElementById('pathReturn').classList.toggle('selected',path==='return');
};

window.resetPath=()=>{
  document.getElementById('newForm').classList.add('hidden');
  document.getElementById('returnForm').classList.add('hidden');
  document.getElementById('pathNew').classList.remove('selected');
  document.getElementById('pathReturn').classList.remove('selected');
  document.getElementById('profileFound').classList.remove('show');
  document.getElementById('editFields').classList.add('hidden');
  document.getElementById('rPhone').value='';
  foundPerson=null;
  // Reset verification panel
  document.getElementById('verifyPanel').classList.remove('show');
  document.getElementById('submitNewBtn').classList.remove('hidden');
  document.getElementById('nVerifyCode').value='';
  hideMsg('verifyError');
  pendingVerifyId=null; pendingVerifyCode=null; pendingVerifyEmail=null; pendingFormData=null;
};

// FASTING TOGGLE
window.toggleFast=()=>{fastOn=!fastOn;document.getElementById('fastSw').classList.toggle('on',fastOn);document.getElementById('nFastToggle').classList.toggle('on',fastOn)};
window.toggleEditFast=()=>{eFastOn=!eFastOn;document.getElementById('eFastSw').classList.toggle('on',eFastOn);document.getElementById('eFastToggle').classList.toggle('on',eFastOn);};

// ‚îÄ‚îÄ EMAIL VERIFICATION STATE ‚îÄ‚îÄ
let pendingVerifyId = null;
let pendingVerifyCode = null;
let pendingVerifyEmail = null;
let pendingFormData = null;

// STEP 1: Validate form, save to localStorage, send Firebase email link
window.sendVerifyCode = async () => {
  if(!authReady){showMsg('newError','Please wait a moment and try again.');return;}

  const btn = document.getElementById('submitNewBtn');
  const resetBtn = () => { btn.disabled=false; document.getElementById('submit-label').textContent=t('submit-label'); };

  const name    = document.getElementById('nName').value.trim();
  const email   = document.getElementById('nEmail').value.trim().toLowerCase();
  const phone   = invitePhone ? normPhone(invitePhone) : normPhone(document.getElementById('nPhone').value.trim());
  const uni     = document.getElementById('nUni').value.trim();
  const year    = document.getElementById('nYear').value;
  const city    = document.getElementById('nCity').value.trim();
  const country = document.getElementById('nCountry').value.trim();
  hideMsg('newError'); hideMsg('newSuccess');

  // Validate
  if(!name || !email || !phone || !uni || !year || !city){ showMsg('newError', t('err-required')); return; }
  if(phone.replace(/[\s\+\-\(\)]/g,'').length < 7){ showMsg('newError', t('err-phone')); return; }
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showMsg('newError', t('err-email')); return; }

  btn.disabled = true;
  document.getElementById('submit-label').textContent = '...';

  // Duplicate check
  let allPeopleSnap, allPendingSnap;
  try {
    allPeopleSnap = await getDocs(collection(db,'people'));
    allPendingSnap = await getDocs(collection(db,'pending'));
  } catch(err) {
    showMsg('newError','‚ö†Ô∏è Could not connect to database: '+err.message);
    resetBtn(); return;
  }

  const dupPerson = allPeopleSnap.docs.find(d => normPhone(d.data().phone||'') === phone);
  if(dupPerson){
    showMsg('newError', lang==='ar'
      ? 'Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÇŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ.'
      : lang==='en' ? 'This number is already registered.' : 'Ce num√©ro est d√©j√† inscrit.');
    resetBtn(); return;
  }
  const dupEmail = allPeopleSnap.docs.find(d => (d.data().email||'').toLowerCase() === email);
  if(dupEmail){
    showMsg('newError', lang==='ar'
      ? 'Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÖÿ≥ÿ¨ŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ.'
      : lang==='en' ? 'This email is already registered.' : 'Cet e-mail est d√©j√† inscrit.');
    resetBtn(); return;
  }
  const dupPending = allPendingSnap.docs.find(d => normPhone(d.data().phone||'')===phone && d.data().status==='pending');
  if(dupPending){
    showMsg('newError', lang==='ar'
      ? 'ÿ∑ŸÑÿ®ŸÉ ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿ®ÿßŸÑŸÅÿπŸÑ.'
      : lang==='en' ? 'Your request is already pending review.' : 'Votre demande est d√©j√† en attente.');
    resetBtn(); return;
  }

  // Save form data to localStorage (survives the redirect)
  localStorage.setItem('sofra_verify_email', email);
  localStorage.setItem('sofra_form_data', JSON.stringify({name,email,phone,uni,year,city,country,fasting:fastOn,lang}));
  if(inviteId) localStorage.setItem('sofra_invite_id', inviteId);

  // Send Firebase email link
  const currentUrl = window.location.href.split('?')[0] + (inviteId ? '?invite='+inviteId : '');
  try {
    await sendSignInLinkToEmail(auth, email, {
      url: currentUrl,
      handleCodeInApp: true
    });
  } catch(err) {
    showMsg('newError','‚ö†Ô∏è Impossible d'envoyer l'email: '+err.message);
    resetBtn(); return;
  }

  // Show "check your email" screen
  document.getElementById('submitNewBtn').classList.add('hidden');
  document.getElementById('verifyPanel').classList.add('show');
  const sentMsg = lang==='ar'
    ? `üìß ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ•ŸÑŸâ ${email} ‚Äî ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ÿ±ŸäÿØŸÉ ŸàÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿ±ÿßÿ®ÿ∑`
    : lang==='en' ? `üìß Verification link sent to ${email} ‚Äî check your inbox and click the link`
    : `üìß Lien envoy√© √† ${email} ‚Äî v√©rifiez votre bo√Æte mail et cliquez sur le lien`;
  document.getElementById('vcode-sent-msg').textContent = sentMsg;
  btn.disabled = false;
  document.getElementById('submit-label').textContent = t('submit-label');
};

window.resendCode = async () => {
  const email = localStorage.getItem('sofra_verify_email');
  if(!email){ return; }
  const btn = document.getElementById('resendBtn');
  btn.disabled = true;
  try {
    const currentUrl = window.location.href.split('?')[0] + (inviteId ? '?invite='+inviteId : '');
    await sendSignInLinkToEmail(auth, email, { url: currentUrl, handleCodeInApp: true });
    toast('üìß Nouveau lien envoy√© !');
    hideMsg('verifyError');
  } catch(e){ showMsg('verifyError','‚ö†Ô∏è √âchec: '+e.message); }
  btn.disabled = false;
};

// Email verification handled by Firebase email link ‚Äî see top of file
// SUBMIT NEW (legacy ‚Äî now replaced by two-step flow above)
window.submitNew=async()=>{window.sendVerifyCode();};


// LOOKUP PHONE (returning student)
window.lookupPhone=async()=>{
  if(!authReady){showMsg('retError','Please wait, loading...');return;}
  const phone=normPhone(document.getElementById('rPhone').value.trim());
  if(!phone||phone.replace(/[^\d]/g,'').length<7){showMsg('retError',t('err-phone'));return;}
  const btn=document.getElementById('lookupBtn');btn.disabled=true;btn.querySelector('span').textContent='...';
  hideMsg('retError');
  document.getElementById('profileFound').classList.remove('show');
  document.getElementById('editFields').classList.add('hidden');

  // Search all people and compare normalized phones
  const allSnap=await getDocs(collection(db,'people'));
  const match=allSnap.docs.find(d=>{
    const dp=d.data().phone||'';
    return normPhone(dp)===phone;
  });

  btn.disabled=false;btn.querySelector('span').textContent=t('r-search-btn');

  if(!match){showMsg('retError',t('err-notfound'));return;}

  foundPerson={id:match.id,...match.data()};
  const p=foundPerson;

  document.getElementById('pfName').textContent=p.name||'‚Äî';
  document.getElementById('pfDetails').innerHTML=
    `${p.university?'üéì '+p.university+'<br>':''}${p.yearOfStudy?'üìö Year '+p.yearOfStudy+'<br>':''}${p.city?'üìç '+p.city+'<br>':''}${p.fasting?'üåô Fasting':''}`;
  document.getElementById('profileFound').classList.add('show');
  // Pre-fill edit fields
  document.getElementById('eName').value=p.name||'';
  document.getElementById('eUni').value=p.university||'';
  document.getElementById('eYear').value=p.yearOfStudy||'';
  document.getElementById('eCountry').value=p.country||'';
  document.getElementById('eCity').value=p.city||'';
  eFastOn=p.fasting||false;
  document.getElementById('eFastSw').classList.toggle('on',eFastOn);
  document.getElementById('eFastToggle').classList.toggle('on',eFastOn);
};

window.confirmProfile=async()=>{
  if(!foundPerson)return;
  // Just show success ‚Äî no DB write needed for simple confirmation
  // Admin can see verified status in the app
  document.getElementById('returnForm').classList.add('hidden');
  document.getElementById('pathSelector').classList.add('hidden');
  document.getElementById('successScreen').classList.add('show');
  document.getElementById('s-title').textContent=t('ok-verified');
  document.getElementById('s-body').textContent='';
  document.getElementById('s-badge').textContent='‚úÖ Confirm√©';
  document.getElementById('s-badge').style.background='var(--green-dim)';
  document.getElementById('s-badge').style.color='var(--green)';
  document.getElementById('successScreen').querySelector('.success-icon').textContent='‚úÖ';
};

window.editProfile=()=>{document.getElementById('editFields').classList.toggle('hidden');};

window.submitEdit=async()=>{
  if(!foundPerson)return;
  if(!authReady){showMsg('retError','Please wait a moment and try again.');return;}
  const name=document.getElementById('eName').value.trim();
  const uni=document.getElementById('eUni').value.trim();
  const year=document.getElementById('eYear').value;
  const country=document.getElementById('eCountry').value.trim();
  const city=document.getElementById('eCity').value.trim();
  if(!name){showMsg('retError',t('err-required'));return;}
  const btn=document.getElementById('e-save');
  btn.disabled=true;btn.textContent='...';
  try {
    await addDoc(collection(db,'pending'),{
      name, university:uni, yearOfStudy:year, country, city,
      phone:foundPerson.phone||'',
      fasting:eFastOn,
      status:'pending',
      type:'edit-request',
      targetPersonId:foundPerson.id,
      originalName:foundPerson.name||'',
      submittedAt:serverTimestamp(),
      submittedAtMs:Date.now(),
      source:'self-edit'
    });
    btn.disabled=false;btn.textContent=t('e-save');
    document.getElementById('returnForm').classList.add('hidden');
    document.getElementById('pathSelector').classList.add('hidden');
    document.getElementById('successScreen').classList.add('show');
    document.getElementById('s-title').textContent=t('ok-updated');
  } catch(err) {
    console.error('Edit submit error:',err);
    btn.disabled=false;btn.textContent=t('e-save');
    showMsg('retError','‚ö†Ô∏è Something went wrong: '+err.message+'. Please try again.');
  }
};

function toast(msg, dur=3000){const el=document.getElementById('regToast');el.textContent=msg;el.style.opacity='1';el.style.transform='translateY(0)';clearTimeout(el._t);el._t=setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(10px)'},dur);}
function showMsg(id,msg){const el=document.getElementById(id);el.textContent=msg;el.style.display='block';}
function hideMsg(id){document.getElementById(id).style.display='none';}
</script>
</body>
</html>